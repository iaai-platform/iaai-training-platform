<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= course.basic?.title || course.title || 'Course' %> - Self-Paced Online Training</title>
  <meta name="description" content="<%= course.basic?.description || '' %>">
  <link rel="stylesheet" href="/css/course-details.css">
  
  <!-- Social Media Preview Tags -->
  <meta property="og:title" content="<%= course.basic?.title || '' %>">
  <meta property="og:description" content="<%= course.basic?.description || '' %>">
  <meta property="og:image" content="<%= course.media?.thumbnailUrl || '/images/IAAI-Logo.jpg' %>">
  <meta property="og:url" content="<%= seoData?.url || '' %>">
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    /* Enhanced Preview Video Styles */
    .preview-videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .preview-video-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .preview-video-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      border-color: #b8860b;
    }
    
    .preview-thumbnail {
      position: relative;
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #002147 0%, #003366 100%);
      cursor: pointer;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .preview-thumbnail::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(184, 134, 11, 0.1) 0%, rgba(0, 33, 71, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .preview-thumbnail:hover::before {
      opacity: 1;
    }
    
    .preview-play-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      background: rgba(184, 134, 11, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .preview-thumbnail:hover .preview-play-overlay {
      background: #b8860b;
      transform: translate(-50%, -50%) scale(1.1);
      box-shadow: 0 8px 20px rgba(184, 134, 11, 0.4);
    }
    
    .preview-duration {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      z-index: 5;
    }
    
    .preview-badge {
      position: absolute;
      top: 15px;
      left: 15px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 5;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .preview-content {
      padding: 25px;
    }
    
    .preview-title {
      font-size: 18px;
      font-weight: 700;
      color: #002147;
      margin: 0 0 12px 0;
      line-height: 1.4;
    }
    
    .preview-description {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin: 0 0 20px 0;
    }
    
    .preview-watch-btn {
      width: 100%;
      background: linear-gradient(135deg, #b8860b 0%, #d4a017 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .preview-watch-btn:hover {
      background: linear-gradient(135deg, #d4a017 0%, #b8860b 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(184, 134, 11, 0.3);
    }
    
    .preview-watch-btn:active {
      transform: translateY(0);
    }
    
    /* Inline Video Player Styles */
    .inline-video-container {
      display: none;
      position: relative;
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .video-close-inline {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      z-index: 20;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-close-inline:hover {
      background: #dc3545;
      transform: scale(1.1);
    }
    
    .inline-video-player {
      width: 100%;
      height: 300px;
      background: #000;
      border: none;
      outline: none;
    }
    
    .time-remaining-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 15;
    }
    
    /* Preview CTA Styles */
    .preview-cta {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px dashed #b8860b;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      margin-top: 25px;
    }
    
    .preview-cta p {
      color: #666;
      margin-bottom: 20px;
      font-size: 16px;
    }
    
    .preview-cta .btn-primary {
      background: linear-gradient(135deg, #b8860b 0%, #d4a017 100%);
      color: white;
      padding: 15px 35px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .preview-cta .btn-primary:hover {
      background: linear-gradient(135deg, #d4a017 0%, #b8860b 100%);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(184, 134, 11, 0.3);
    }
    
    /* Enhanced Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      right: -400px;
      max-width: 400px;
      padding: 20px 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 15px;
      transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 1000;
      border-left: 5px solid #28a745;
    }
    
    .notification.show {
      right: 20px;
    }
    
    .notification.error {
      border-left-color: #dc3545;
    }
    
    .notification.warning {
      border-left-color: #ffc107;
    }
    
    .notification-icon {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 20px;
    }
    
    .notification.success .notification-icon {
      background: #d4f4dd;
      color: #2e7d3e;
    }
    
    .notification.error .notification-icon {
      background: #f8d7da;
      color: #721c24;
    }
    
    .notification.warning .notification-icon {
      background: #fff3cd;
      color: #856404;
    }
    
    .notification-content h4 {
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 700;
      color: #333;
    }
    
    .notification-content p {
      margin: 0;
      font-size: 14px;
      color: #666;
      line-height: 1.4;
    }
    
    /* Loading State */
    .btn-loading {
      pointer-events: none;
      opacity: 0.7;
      position: relative;
    }
    
    .btn-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* FAQ Styles */
    .faq-accordion {
      max-width: 100%;
    }
    
    .faq-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    
    .faq-question {
      padding: 20px;
      background: #f8f9fa;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s ease;
    }
    
    .faq-question:hover {
      background: #e9ecef;
    }
    
    .faq-question h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    
    .faq-icon {
      transition: transform 0.3s ease;
      color: #666;
    }
    
    .faq-item.active .faq-icon {
      transform: rotate(180deg);
    }
    
    .faq-answer {
      display: none;
      padding: 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
    }
    
    .faq-item.active .faq-answer {
      display: block;
    }
    
    .faq-answer p {
      margin: 0;
      color: #555;
      line-height: 1.6;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .preview-videos-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .preview-video-card {
        margin: 0 10px;
      }
      
      .preview-thumbnail {
        height: 180px;
      }
      
      .preview-content {
        padding: 20px;
      }
      
      .notification {
        left: 10px;
        right: 10px;
        max-width: none;
        transform: translateX(0);
      }
      
      .notification.show {
        right: 10px;
      }
    }
  </style>
</head>

<body>
  <%- include('partials/header') %>

  <!-- Enhanced Breadcrumb -->
  <nav class="breadcrumb">
    <a href="/"><i class="fas fa-home"></i> Home</a> 
    <i class="fas fa-chevron-right" style="margin: 0 10px; color: #999; font-size: 12px;"></i>
    <a href="/training-programs">Training Programs</a> 
    <i class="fas fa-chevron-right" style="margin: 0 10px; color: #999; font-size: 12px;"></i>
    <a href="/self-paced-online-training">Self-Paced Online Training</a>
    <i class="fas fa-chevron-right" style="margin: 0 10px; color: #999; font-size: 12px;"></i>
    <span><%= course.basic?.title || course.title || 'Course Details' %></span>
  </nav>

  <!-- Enhanced Hero Section -->
  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-header">
        <div class="hero-info">
          <div class="course-code-badge">
            <i class="fas fa-tag"></i> <%= course.basic?.courseCode || course.courseCode || 'N/A' %>
            <% if (course.basic?.category) { %>
              <span class="category-badge"><%= course.basic.category.toUpperCase() %></span>
            <% } %>
          </div>
          <h1 class="hero-title"><%= course.basic?.title || course.title || 'Self-Paced Online Training Course' %></h1>
          <p class="hero-description"><%= course.basic?.description || course.description || 'Master new skills at your own pace with our comprehensive video-based training program.' %></p>
          
          <% if (course.basic?.aboutThisCourse) { %>
          <div class="hero-about">
            <%= course.basic.aboutThisCourse %>
          </div>
          <% } %>
          
          <div class="hero-meta">
            <div class="meta-item">
              <i class="fas fa-user-md"></i>
              <span><%= course.instructor?.name || 'Expert Instructors' %></span>
            </div>
            <div class="meta-item">
              <i class="fas fa-play-circle"></i>
              <span><%= course.videos?.length || 0 %> Video Lessons</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-clock"></i>
              <span>
                <% if (courseMetrics?.totalDuration) { %>
                  <%= Math.round(courseMetrics.totalDuration / 60 * 10) / 10 %> hours
                <% } else if (course.content?.estimatedMinutes) { %>
                  <%= Math.round(course.content.estimatedMinutes / 60 * 10) / 10 %> hours
                <% } else { %>
                  Self-paced
                <% } %>
              </span>
            </div>
            <div class="meta-item">
              <i class="fas fa-graduation-cap"></i>
              <span><%= course.content?.experienceLevel || 'All Levels' %></span>
            </div>
            <% if (courseMetrics?.enrollmentCount > 0) { %>
            <div class="meta-item">
              <i class="fas fa-users"></i>
              <span><%= courseMetrics.enrollmentCount %> Students</span>
            </div>
            <% } %>
          </div>
        </div>
        
        <div class="hero-actions">
          <div class="price-display">
            <span class="price-label">Course Price</span>
            <% if ((course.access?.price || 0) === 0) { %>
              <div class="free-badge">FREE</div>
            <% } else { %>
              <div class="price-amount">
                <span class="price-currency">$</span><%= course.access?.price || 0 %>
              </div>
            <% } %>
          </div>
          
          <div class="action-buttons">
            <% if (typeof user !== 'undefined' && user) { %>
              <% if (hasAccess) { %>
                <!-- User already has access -->
                <a href="/library" class="btn-primary">
                  <i class="fas fa-book"></i> Go to My Library
                </a>
              <% } else { %>
                <!-- Add to Cart/Wishlist -->
                <button class="btn-primary add-to-cart-btn" 
                        data-course-id="<%= course._id %>" 
                        data-course-type="SelfPacedOnlineTraining"
                        data-price="<%= course.access?.price || 0 %>"
                        data-course-code="<%= course.basic?.courseCode || 'N/A' %>"
                        data-course-title="<%= course.basic?.title || 'Untitled Course' %>"
                        <%= (course.basic?.status !== 'published') ? 'disabled' : '' %>>
                  <i class="fas fa-shopping-cart"></i> 
                  <%= ((course.access?.price || 0) === 0) ? 'Enroll for Free' : 'Add to Cart' %>
                </button>
                
                <button class="btn-secondary add-to-wishlist-btn" 
                        data-course-id="<%= course._id %>" 
                        data-course-type="SelfPacedOnlineTraining"
                        data-price="<%= course.access?.price || 0 %>"
                        data-course-code="<%= course.basic?.courseCode || 'N/A' %>"
                        data-course-title="<%= course.basic?.title || 'Untitled Course' %>">
                  <i class="fas fa-heart"></i> Save to Wishlist
                </button>
              <% } %>
            <% } else { %>
              <button class="btn-primary" id="login-required-btn">
                <i class="fas fa-shopping-cart"></i> 
                <%= ((course.access?.price || 0) === 0) ? 'Enroll for Free' : 'Add to Cart' %>
              </button>
              <button class="btn-secondary" id="login-required-wishlist-btn">
                <i class="fas fa-heart"></i> Save to Wishlist
              </button>
            <% } %>
          </div>
          
          <div class="access-info">
            <div class="access-duration">
              <i class="fas fa-infinity"></i>
              <span>
                <%= course.access?.accessDays ? 
                    (course.access.accessDays === 0 ? 'Lifetime Access' : course.access.accessDays + ' Days Access') : 
                    'Lifetime Access' %>
              </span>
            </div>
            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">
              <i class="fas fa-mobile-alt"></i> Access on any device
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Enhanced Quick Info Bar -->
    <div class="quick-info-bar">
      <div class="info-item">
        <div class="info-icon">
          <i class="fas fa-play-circle"></i>
        </div>
        <div class="info-label">Video Lessons</div>
        <div class="info-value"><%= course.videos?.length || 0 %></div>
      </div>
      
      <div class="info-item">
        <div class="info-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="info-label">Duration</div>
        <div class="info-value">
          <% if (courseMetrics?.totalDuration) { %>
            <%= Math.round(courseMetrics.totalDuration / 60 * 10) / 10 %>h
          <% } else if (course.content?.estimatedMinutes) { %>
            <%= Math.round(course.content.estimatedMinutes / 60 * 10) / 10 %>h
          <% } else { %>
            Self-paced
          <% } %>
        </div>
      </div>
      
      <div class="info-item">
        <div class="info-icon">
          <i class="fas fa-question-circle"></i>
        </div>
        <div class="info-label">Quiz Questions</div>
        <div class="info-value"><%= courseMetrics?.totalQuizQuestions || 0 %></div>
      </div>
      
      <div class="info-item">
        <div class="info-icon">
          <i class="fas fa-certificate"></i>
        </div>
        <div class="info-label">Certificate</div>
        <div class="info-value"><%= course.certification?.enabled ? 'Yes' : 'No' %></div>
      </div>
      
      <div class="info-item">
        <div class="info-icon">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="info-label">Level</div>
        <div class="info-value">
          <%= course.content?.experienceLevel || 'All Levels' %>
        </div>
      </div>
      
      <div class="info-item">
        <div class="info-icon">
          <i class="fas fa-language"></i>
        </div>
        <div class="info-label">Language</div>
        <div class="info-value">English</div>
      </div>
      
      <div class="info-item">
        <div class="info-icon">
          <i class="fas fa-infinity"></i>
        </div>
        <div class="info-label">Access</div>
        <div class="info-value">
          <%= course.access?.accessDays === 0 || !course.access?.accessDays ? 'Lifetime' : course.access.accessDays + ' Days' %>
        </div>
      </div>
      
      <% if (courseMetrics?.enrollmentCount > 0) { %>
      <div class="info-item">
        <div class="info-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="info-label">Students</div>
        <div class="info-value"><%= courseMetrics.enrollmentCount %></div>
      </div>
      <% } %>
    </div>

    <!-- Course Content/Videos with Proper Preview Functionality -->
    <div class="content-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-play-circle"></i>
        </div>
        <h2 class="section-title">Course Content</h2>
      </div>
      
      <% if (courseMetrics?.totalDuration || courseMetrics?.totalQuizQuestions) { %>
      <div class="course-stats">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number"><%= course.videos?.length || 0 %></div>
            <div class="stat-label">Videos</div>
          </div>
          <% if (courseMetrics?.totalDuration) { %>
          <div class="stat-item">
            <div class="stat-number"><%= Math.round(courseMetrics.totalDuration / 60 * 10) / 10 %></div>
            <div class="stat-label">Hours</div>
          </div>
          <% } %>
          <% if (courseMetrics?.totalQuizQuestions > 0) { %>
          <div class="stat-item">
            <div class="stat-number"><%= courseMetrics.totalQuizQuestions %></div>
            <div class="stat-label">Quiz Questions</div>
          </div>
          <% } %>
          <% if (courseMetrics?.hasQuizzes) { %>
          <div class="stat-item">
            <div class="stat-number">✓</div>
            <div class="stat-label">Assessments</div>
          </div>
          <% } %>
        </div>
      </div>
      <% } %>
      
      <% if (hasAccess) { %>
        <!-- Show full content for enrolled users -->
        <div class="video-curriculum">
          <% if (course.videos && course.videos.length > 0) { %>
            <% course.videos.forEach((video, index) => { %>
            <div class="video-item">
              <div class="video-header">
                <div class="video-number">
                  <i class="fas fa-play-circle"></i>
                  Video <%= index + 1 %>
                </div>
                <% if (video.duration) { %>
                <span class="video-duration">
                  <i class="far fa-clock"></i> <%= video.duration %> min
                </span>
                <% } %>
              </div>
              
              <h3 class="video-title"><%= video.title %></h3>
              <% if (video.description) { %>
              <p class="video-description"><%= video.description %></p>
              <% } %>
              
              <div class="video-actions">
                <% if (video.videoUrl || video.url) { %>
                <a href="<%= video.videoUrl || video.url %>" target="_blank" class="watch-btn">
                  <i class="fas fa-play"></i> Watch Video
                </a>
                <% } %>
                <% if (video.exam && video.exam.length > 0) { %>
                <span class="quiz-indicator">
                  <i class="fas fa-question-circle"></i> 
                  Quiz Available (<%= video.exam.length %> questions)
                </span>
                <% } %>
                <% if (video.transcript) { %>
                <button class="btn-secondary transcript-toggle" data-video-index="<%= index %>" style="padding: 8px 16px; font-size: 12px;">
                  <i class="fas fa-file-text"></i> Transcript
                </button>
                <div id="transcript-<%= index %>" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; line-height: 1.6;">
                  <%= video.transcript %>
                </div>
                <% } %>
              </div>
            </div>
            <% }) %>
          <% } else { %>
            <div class="video-item">
              <div class="video-header">
                <div class="video-number">
                  <i class="fas fa-play-circle"></i>
                  Course Content
                </div>
              </div>
              <h3 class="video-title">Access Your Learning Materials</h3>
              <p class="video-description">Your course content is being prepared. Please check back soon or contact support for assistance.</p>
              <div class="video-actions">
                <a href="/library" class="watch-btn">
                  <i class="fas fa-book"></i> Go to Library
                </a>
              </div>
            </div>
          <% } %>
        </div>
      <% } else { %>
        <!-- Enhanced Preview Section with Working Inline Video Player -->
        <% 
        const previewVideos = course.videos ? course.videos.filter(v => v.isPreview) : [];
        %>
        <% if (previewVideos.length > 0) { %>
        <div class="preview-section" style="margin-bottom: 30px;">
          <h3 style="color: #002147; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-eye" style="color: #b8860b;"></i>
            Free Preview - See What You'll Learn
          </h3>
          
          <div class="preview-videos-grid">
            <% previewVideos.forEach((video, index) => { %>
            <div class="preview-video-card">
              <div class="preview-thumbnail" 
                   data-video-url="<%= video.videoUrl || video.url || '' %>" 
                   data-video-title="<%= (video.title || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;') %>" 
                   data-container-id="preview-<%= index %>">
                <div class="preview-play-overlay">
                  <i class="fas fa-play"></i>
                </div>
                <% if (video.duration) { %>
                <div class="preview-duration">
                  <i class="fas fa-clock"></i> <%= video.duration %> min
                </div>
                <% } else { %>
                <div class="preview-duration">
                  <i class="fas fa-clock"></i> Preview
                </div>
                <% } %>
                <div class="preview-badge">FREE PREVIEW</div>
              </div>
              
              <div class="preview-content">
                <h4 class="preview-title"><%= video.title || 'Preview Video' %></h4>
                <p class="preview-description"><%= video.description || 'Get a taste of what this course offers' %></p>
                
                <!-- Watch/Hide Video Button with Data Attributes -->
                <button class="preview-watch-btn" 
                        data-video-url="<%= video.videoUrl || video.url || '' %>" 
                        data-video-title="<%= (video.title || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;') %>" 
                        data-container-id="preview-<%= index %>">
                  <i class="fas fa-play"></i>
                  <span class="video-toggle-text" id="toggleText-preview-<%= index %>">Watch Preview Video</span>
                </button>
                
                <!-- Inline Video Container -->
                <div id="inlineVideoContainer-preview-<%= index %>" class="inline-video-container">
                  <button class="video-close-inline" data-container-id="preview-<%= index %>">&times;</button>
                  <video id="inlineVideo-preview-<%= index %>" class="inline-video-player" controls preload="metadata">
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                </div>
              </div>
            </div>
            <% }) %>
          </div>
          
          <div class="preview-cta">
            <p>
              <strong>This is just the beginning!</strong> Unlock <%= course.videos.length - previewVideos.length %> more videos with full course access.
            </p>
            <button class="btn-primary" id="scroll-to-enrollment">
              <i class="fas fa-unlock"></i> Unlock Full Course
            </button>
          </div>
        </div>
        <% } else { %>
        <!-- No preview videos available -->
        <div class="preview-section" style="margin-bottom: 30px;">
          <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 15px; border: 2px dashed #dee2e6;">
            <div style="font-size: 48px; margin-bottom: 20px; color: #6c757d;">🎥</div>
            <h3 style="color: #495057; margin-bottom: 15px;">Course Content Available After Enrollment</h3>
            <p style="color: #6c757d; margin-bottom: 25px;">This course contains <%= course.videos?.length || 0 %> video lessons with comprehensive training materials.</p>
            <button class="btn-primary" id="scroll-to-enrollment-alt">
              <i class="fas fa-unlock"></i> Enroll to Access Content
            </button>
          </div>
        </div>
        <% } %>
      <% } %>
    </div>

    <!-- FAQ Section -->
    <div class="content-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-question-circle"></i>
        </div>
        <h2 class="section-title">Frequently Asked Questions</h2>
      </div>
      
      <div class="faq-accordion">
        <div class="faq-item">
          <div class="faq-question">
            <h4>How long do I have access to the course?</h4>
            <i class="fas fa-chevron-down faq-icon"></i>
          </div>
          <div class="faq-answer">
            <p>
              You have lifetime access to this course. Once enrolled, you can access all materials anytime, anywhere, and revisit content as often as you'd like.
            </p>
          </div>
        </div>
        
        <div class="faq-item">
          <div class="faq-question">
            <h4>Can I download the videos for offline viewing?</h4>
            <i class="fas fa-chevron-down faq-icon"></i>
          </div>
          <div class="faq-answer">
            <p>While videos are not downloadable for copyright protection, you can access them anytime with an internet connection. We also provide downloadable resources and materials to support your learning.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <div class="faq-question">
            <h4>Is there a certificate provided upon completion?</h4>
            <i class="fas fa-chevron-down faq-icon"></i>
          </div>
          <div class="faq-answer">
            <p>Yes! Upon successful completion of all course requirements, you'll receive a digital Certificate of Completion that you can download and share on professional networks.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Action Bar -->
  <div class="mobile-action-bar">
    <div class="mobile-action-content">
      <div class="mobile-price">
        <% if ((course.access?.price || 0) === 0) { %>
          FREE
        <% } else { %>
          $<%= course.access?.price || 0 %>
        <% } %>
      </div>
      <div class="mobile-buttons">
        <% if (typeof user !== 'undefined' && user) { %>
          <% if (hasAccess) { %>
            <a href="/library" class="btn-primary" style="padding: 12px 20px; font-size: 14px; text-decoration: none;">
              <i class="fas fa-book"></i> Go to Library
            </a>
          <% } else { %>
            <button class="btn-primary add-to-cart-btn" 
                    data-course-id="<%= course._id %>" 
                    data-course-type="SelfPacedOnlineTraining"
                    data-price="<%= course.access?.price || 0 %>"
                    data-course-code="<%= course.basic?.courseCode || 'N/A' %>"
                    data-course-title="<%= course.basic?.title || 'Untitled Course' %>"
                    style="padding: 12px 20px; font-size: 14px;">
              <i class="fas fa-shopping-cart"></i> 
              <%= ((course.access?.price || 0) === 0) ? 'Enroll Free' : 'Add to Cart' %>
            </button>
          <% } %>
        <% } else { %>
          <button class="btn-primary" id="mobile-login-required" style="padding: 12px 20px; font-size: 14px;">
            <i class="fas fa-shopping-cart"></i> 
            <%= ((course.access?.price || 0) === 0) ? 'Enroll Free' : 'Add to Cart' %>
          </button>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <!-- JavaScript with Working Video Preview -->
<!-- Only the JavaScript section needs changes - replace the entire script section with this: -->
<!-- Replace the entire <script> section in your course details page with this: -->

  <script>
    // ✅ FIXED: Proper data passing from EJS to JavaScript
    const courseData = {
        id: '<%= course._id %>',
        title: <%- JSON.stringify(course.basic?.title || course.title || 'Course') %>,
        price: <%= course.access?.price || 0 %>,
        videosCount: <%= course.videos?.length || 0 %>,
        previewVideosCount: <%= course.videos ? course.videos.filter(v => v.isPreview).length : 0 %>
    };
    
    const userLoggedIn = <%= (typeof user !== 'undefined' && user) ? 'true' : 'false' %>;
    const hasAccess = <%= hasAccess ? 'true' : 'false' %>;
    const courseMetrics = <%- JSON.stringify(courseMetrics || {}) %>;

    console.log('🎬 Enhanced self-paced course details page loaded');
    console.log('👤 User logged in:', userLoggedIn);
    console.log('🎥 Course ID:', courseData.id);
    console.log('💰 Course price:', courseData.price);
    console.log('📹 Videos available:', courseData.videosCount);
    console.log('🔗 User has access:', hasAccess);

    // Enhanced notification system
    function showNotification(title, message, type = 'success') {
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      const iconMap = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle'
      };
      
      notification.innerHTML = `
        <div class="notification-icon">
          <i class="fas ${iconMap[type]}"></i>
        </div>
        <div class="notification-content">
          <h4>${title}</h4>
          <p>${message}</p>
        </div>
      `;
      
      container.appendChild(notification);
      
      // Show notification
      setTimeout(() => notification.classList.add('show'), 10);
      
      // Auto remove
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 500);
      }, 5000);
    }

    // Login required handler
    function showLoginRequired() {
      showNotification('Authentication Required', 'Please log in to continue', 'warning');
      setTimeout(() => window.location.href = '/login', 2000);
    }

    // Enhanced button loading state
    function setButtonLoading(button, loading) {
      if (loading) {
        button.classList.add('btn-loading');
        button.disabled = true;
        const originalText = button.innerHTML;
        button.setAttribute('data-original-text', originalText);
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
      } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
          button.innerHTML = originalText;
        }
      }
    }

    // Video Preview Functions (keep existing video preview code)
    let videoTimers = {};
    
    function toggleInlineVideo(videoUrl, videoTitle, containerId) {
      console.log('🎬 toggleInlineVideo called:', { videoUrl, videoTitle, containerId });
      
      const container = document.getElementById(`inlineVideoContainer-${containerId}`);
      const video = document.getElementById(`inlineVideo-${containerId}`);
      const toggleText = document.getElementById(`toggleText-${containerId}`);
      
      if (!container || !video || !toggleText) {
        console.error('❌ Video elements not found for:', containerId);
        return;
      }
      
      if (container.style.display === 'none' || container.style.display === '') {
        const source = video.querySelector('source');
        if (source) {
          source.src = videoUrl;
          video.load();
        }
        
        container.style.display = 'block';
        toggleText.textContent = 'Hide Preview Video';
        
        addTimeOverlay(container, containerId);
        setupVideoTimer(video, containerId, videoTitle);
        
        setTimeout(() => {
          container.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
        }, 100);
        
        console.log('✅ Video opened with 30-second limit:', videoTitle);
      } else {
        closeInlineVideo(containerId);
      }
    }

    function addTimeOverlay(container, containerId) {
      const existingOverlay = container.querySelector('.time-remaining-overlay');
      if (existingOverlay) {
        existingOverlay.remove();
      }
      
      const timeOverlay = document.createElement('div');
      timeOverlay.className = 'time-remaining-overlay';
      timeOverlay.id = `timeOverlay-${containerId}`;
      timeOverlay.innerHTML = `
        <div style="position: absolute; top: 15px; left: 15px; background: rgba(220, 53, 69, 0.9); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 15; display: flex; align-items: center; gap: 5px;">
          <i class="fas fa-clock"></i>
          <span id="timeLeft-${containerId}">30s remaining</span>
        </div>
        <div style="position: absolute; top: 15px; right: 60px; background: rgba(40, 167, 69, 0.9); color: white; padding: 6px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; z-index: 15;">
          🎬 FREE PREVIEW
        </div>
      `;
      container.appendChild(timeOverlay);
    }

    function setupVideoTimer(video, containerId, videoTitle) {
      let timeLeft = 30;
      const timeLeftSpan = document.getElementById(`timeLeft-${containerId}`);
      
      if (videoTimers[containerId]) {
        clearInterval(videoTimers[containerId]);
      }
      
      video.addEventListener('play', function startTimer() {
        if (!videoTimers[containerId]) {
          videoTimers[containerId] = setInterval(() => {
            timeLeft--;
            if (timeLeftSpan) {
              timeLeftSpan.textContent = `${timeLeft}s remaining`;
            }
            
            if (timeLeft <= 0) {
              endPreview(containerId, videoTitle);
            }
          }, 1000);
        }
        video.removeEventListener('play', startTimer);
      });
      
      video.addEventListener('timeupdate', function() {
        if (video.currentTime >= 30) {
          endPreview(containerId, videoTitle);
        }
      });
      
      video.addEventListener('seeked', function() {
        if (video.currentTime > 30) {
          video.currentTime = 30;
          endPreview(containerId, videoTitle);
        }
      });
    }

    function endPreview(containerId, videoTitle) {
      console.log('⏰ Preview ended for:', videoTitle);
      
      const container = document.getElementById(`inlineVideoContainer-${containerId}`);
      const video = document.getElementById(`inlineVideo-${containerId}`);
      
      if (video) {
        video.pause();
      }
      
      if (videoTimers[containerId]) {
        clearInterval(videoTimers[containerId]);
        delete videoTimers[containerId];
      }
      
      if (container) {
        container.innerHTML = `
          <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 40px 20px; text-align: center; border-radius: 12px;">
            <div style="font-size: 48px; margin-bottom: 20px;">🎬</div>
            <h3 style="margin: 0 0 15px 0; font-size: 24px;">Preview Complete!</h3>
            <p style="margin: 0 0 10px 0; font-size: 16px;">You've seen the first 30 seconds of this lesson.</p>
            <p style="margin: 0 0 25px 0; font-size: 18px; font-weight: bold;">Ready to see the rest?</p>
            <button class="unlock-course-btn" data-container-id="${containerId}"
                    style="background: white; color: #dc3545; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s ease;">
              🔓 Unlock Full Course Now!
            </button>
          </div>
        `;
        
        const unlockBtn = container.querySelector('.unlock-course-btn');
        if (unlockBtn) {
          unlockBtn.addEventListener('click', function() {
            scrollToEnrollment();
            closeInlineVideo(this.getAttribute('data-container-id'));
          });
        }
      }
    }

    function closeInlineVideo(containerId) {
      console.log('🔒 closeInlineVideo called:', containerId);
      
      const container = document.getElementById(`inlineVideoContainer-${containerId}`);
      const toggleText = document.getElementById(`toggleText-${containerId}`);
      
      if (videoTimers[containerId]) {
        clearInterval(videoTimers[containerId]);
        delete videoTimers[containerId];
      }
      
      if (container && toggleText) {
        container.style.display = 'none';
        toggleText.textContent = 'Watch Preview Video';
        
        setTimeout(() => {
          if (container.style.display === 'none') {
            container.innerHTML = `
              <button class="video-close-inline" data-container-id="${containerId}">&times;</button>
              <video id="inlineVideo-${containerId}" class="inline-video-player" controls preload="metadata">
                <source src="" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            `;
            
            const closeBtn = container.querySelector('.video-close-inline');
            if (closeBtn) {
              closeBtn.addEventListener('click', function() {
                closeInlineVideo(this.getAttribute('data-container-id'));
              });
            }
          }
        }, 500);
        
        console.log('✅ Video closed:', containerId);
      }
    }

    function scrollToEnrollment() {
      console.log('🎯 scrollToEnrollment called');
      
      const heroActions = document.querySelector('.hero-actions');
      if (heroActions) {
        heroActions.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        const originalBackground = heroActions.style.background;
        heroActions.style.background = 'rgba(184, 134, 11, 0.1)';
        heroActions.style.transition = 'background 0.5s ease';
        
        setTimeout(() => {
          heroActions.style.background = originalBackground;
        }, 2000);
      }
    }

    // DOM Content Loaded Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('📋 DOM loaded, setting up event listeners...');
      
      // Login required buttons
      const loginButtons = ['#login-required-btn', '#login-required-wishlist-btn', '#mobile-login-required'];
      loginButtons.forEach(selector => {
        const btn = document.querySelector(selector);
        if (btn) {
          btn.addEventListener('click', showLoginRequired);
          console.log('✅ Login button listener added:', selector);
        }
      });
      
      // Scroll to enrollment buttons
      const scrollButtons = ['#scroll-to-enrollment', '#scroll-to-enrollment-alt'];
      scrollButtons.forEach(selector => {
        const btn = document.querySelector(selector);
        if (btn) {
          btn.addEventListener('click', scrollToEnrollment);
          console.log('✅ Scroll button listener added:', selector);
        }
      });
      
      // Preview video event listeners
      document.querySelectorAll('.preview-thumbnail').forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', function() {
          const videoUrl = this.getAttribute('data-video-url');
          const videoTitle = this.getAttribute('data-video-title');
          const containerId = this.getAttribute('data-container-id');
          
          console.log('📸 Thumbnail clicked:', { videoUrl, videoTitle, containerId });
          
          if (videoUrl && videoTitle && containerId) {
            toggleInlineVideo(videoUrl, videoTitle, containerId);
          } else {
            console.error('❌ Missing video data attributes');
          }
        });
        console.log('✅ Thumbnail listener added:', index);
      });
      
      document.querySelectorAll('.preview-watch-btn').forEach((button, index) => {
        button.addEventListener('click', function() {
          const videoUrl = this.getAttribute('data-video-url');
          const videoTitle = this.getAttribute('data-video-title');
          const containerId = this.getAttribute('data-container-id');
          
          console.log('▶️ Watch button clicked:', { videoUrl, videoTitle, containerId });
          
          if (videoUrl && videoTitle && containerId) {
            toggleInlineVideo(videoUrl, videoTitle, containerId);
          } else {
            console.error('❌ Missing video data attributes');
          }
        });
        console.log('✅ Watch button listener added:', index);
      });
      
      document.querySelectorAll('.video-close-inline').forEach((button, index) => {
        button.addEventListener('click', function() {
          const containerId = this.getAttribute('data-container-id');
          closeInlineVideo(containerId);
        });
        console.log('✅ Close button listener added:', index);
      });
      
      document.querySelectorAll('.transcript-toggle').forEach((button, index) => {
        button.addEventListener('click', function() {
          const index = this.getAttribute('data-video-index');
          const transcript = document.getElementById(`transcript-${index}`);
          if (transcript) {
            if (transcript.style.display === 'none' || transcript.style.display === '') {
              transcript.style.display = 'block';
            } else {
              transcript.style.display = 'none';
            }
          }
        });
        console.log('✅ Transcript button listener added:', index);
      });
      
      document.querySelectorAll('.faq-question').forEach((question, index) => {
        question.addEventListener('click', function() {
          const faqItem = this.parentElement;
          const wasActive = faqItem.classList.contains('active');
          
          document.querySelectorAll('.faq-item').forEach(item => {
            item.classList.remove('active');
          });
          
          if (!wasActive) {
            faqItem.classList.add('active');
          }
        });
        console.log('✅ FAQ listener added:', index);
      });

      // ✅ CART/WISHLIST EVENT LISTENERS - FIXED SYNTAX
      document.querySelectorAll('.add-to-cart-btn').forEach((button, index) => {
        button.addEventListener('click', async function(e) {
          e.preventDefault();
          
          const courseId = this.getAttribute('data-course-id');
          const courseType = this.getAttribute('data-course-type');
          const courseTitle = this.getAttribute('data-course-title');
          
          console.log('🛒 Add to cart clicked:', { courseId, courseType, courseTitle });
          
          setButtonLoading(this, true);
          
          try {
            const response = await fetch('/add-to-cart', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ courseId, courseType })
            });
            
            const result = await response.json();
            
            if (result.success) {
              showNotification('Added to Cart', `"${courseTitle}" has been added to your cart`, 'success');
              // ⭐ ADD ONLY THIS LINE:
  setTimeout(() => window.location.href = '/orders', 3000);
              
              if (result.linkedCourseAdded) {
                setTimeout(() => {
                  showNotification('Bonus!', 'A linked course was also added to your cart for free!', 'success');
                }, 1500);
              }
            } else {
              showNotification('Error', result.message, 'error');
            }
          } catch (error) {
            console.error('❌ Add to cart error:', error);
            showNotification('Error', 'Failed to add to cart. Please try again.', 'error');
          } finally {
            setButtonLoading(this, false);
          }
        });
        console.log('✅ Cart button listener added:', index);
      });

      document.querySelectorAll('.add-to-wishlist-btn').forEach((button, index) => {
        button.addEventListener('click', async function(e) {
          e.preventDefault();
          
          const courseId = this.getAttribute('data-course-id');
          const courseType = this.getAttribute('data-course-type');
          const courseTitle = this.getAttribute('data-course-title');
          
          console.log('❤️ Add to wishlist clicked:', { courseId, courseType, courseTitle });
          
          setButtonLoading(this, true);
          
          try {
            const response = await fetch('/add-to-wishlist', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ courseId, courseType })
            });
            
            const result = await response.json();
            
            if (result.success) {
              showNotification('Added to Wishlist', `"${courseTitle}" has been saved to your wishlist`, 'success');
              
              this.style.background = '#e74c3c';
              const icon = this.querySelector('i');
              if (icon) {
                icon.classList.remove('far');
                icon.classList.add('fas');
              }
            } else {
              showNotification('Error', result.message, 'error');
            }
          } catch (error) {
            console.error('❌ Add to wishlist error:', error);
            showNotification('Error', 'Failed to add to wishlist. Please try again.', 'error');
          } finally {
            setButtonLoading(this, false);
          }
        });
        console.log('✅ Wishlist button listener added:', index);
      });
      
      console.log('✅ All event listeners set up successfully');
    });

    // Final initialization
    console.log('🚀 All functions defined successfully!');
    console.log('📊 Course metrics available:', courseMetrics);
    console.log('🎬 Preview videos:', courseData.previewVideosCount);
  </script>

  <%- include('partials/footer') %>
</body>
</html>