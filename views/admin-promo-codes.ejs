<!DOCTYPE html>
<html lang="en">
<body>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>International Aesthetic Academic Institution (IAAI)</title>
        <link rel="stylesheet" href="/css/admin.css">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </head>
    
    <%- include('partials/header') %>
    
    <header>
        <h1>Admin Dashboard - User Management-Promo Code</h1>
        <a href="/dashboard" class="cta-btn">Admin Home</a>
    </header>
    
    <div class="container">
        <h1>Promo Code Management</h1>
        
        <!-- Enhanced Add New Promo Code Form -->
        <div class="promo-code-form">
            <h2>Add New Promo Code</h2>
            <form action="/admin-promo-codes/add" method="POST">
                <label>Promo Code Name:</label>
                <input type="text" name="code" required>
                
                <label>Discount Percentage:</label>
                <input type="number" name="discountPercentage" min="1" max="100" required>
                
                <label>Expiration Date (optional):</label>
                <input type="date" name="expiryDate">
                
                <!-- New Restriction Type -->
                <label>Restriction Type:</label>
                <select name="restrictionType" id="restrictionType" onchange="toggleRestrictions()" required>
                    <option value="none">No Restrictions</option>
                    <option value="email">Email Specific</option>
                    <option value="course">Course Specific</option>
                    <option value="both">Both Email & Course</option>
                </select>
                
                <!-- Email Restrictions -->
                <div id="emailRestrictions" style="display: none;">
                    <label>Allowed Email Addresses (one per line):</label>
                    <textarea name="allowedEmails" placeholder="user1@example.com&#10;user2@example.com" rows="3"></textarea>
                </div>
                
                <!-- Course Restrictions -->
                <div id="courseRestrictions" style="display: none;">
                    <label>Allowed Courses:</label>
                    <select name="allowedCourses" multiple>
                        <% courses.forEach(course => { %>
                            <option value="<%= course._id %>">
                                [<%= course.courseType %>] <%= course.title %>
                            </option>
                        <% }) %>
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple courses. Course types: OnlineLive, SelfPaced, InPerson</small>
                </div>
                
                <button type="submit" class="cta-btn">Add Promo Code</button>
            </form>
        </div>
        
        <!-- Enhanced List of Existing Promo Codes -->
        <h2>Active Promo Codes</h2>
        <table class="promo-code-table">
            <thead>
                <tr>
                    <th>Promo Code</th>
                    <th>Discount (%)</th>
                    <th>Restrictions</th>
                    <th>Expiration</th>
                    <th>Active</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <% promoCodes.forEach(promo => { %>
                    <tr>
                        <td><%= promo.code %></td>
                        <td><%= promo.discountPercentage %>%</td>
                        <td>
                            <% if (promo.restrictionType === 'none') { %>
                                No Restrictions
                            <% } else if (promo.restrictionType === 'email') { %>
                                Email: <%= promo.allowedEmails.join(', ') %>
                            <% } else if (promo.restrictionType === 'course') { %>
                                Courses: <% if (promo.allowedCoursesInfo && promo.allowedCoursesInfo.length > 0) { %>
                                    <% promo.allowedCoursesInfo.forEach((courseInfo, index) => { %>
                                        [<%= courseInfo.type %>] <%= courseInfo.title %><% if (index < promo.allowedCoursesInfo.length - 1) { %>, <% } %>
                                    <% }) %>
                                <% } else { %>
                                    <%= promo.allowedCourses.length %> selected
                                <% } %>
                            <% } else if (promo.restrictionType === 'both') { %>
                                Email & Course restrictions
                            <% } %>
                        </td>
                        <td><%= promo.expiryDate ? promo.expiryDate.toDateString() : 'No Expiry' %></td>
                        <td><%= promo.isActive ? 'Yes' : 'No' %></td>
                        <td>
                            <form action="/admin-promo-codes/delete/<%= promo._id %>" method="POST">
                                <button type="submit" class="delete-btn">Delete</button>
                            </form>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
    
    <script>
        function toggleRestrictions() {
            const restrictionType = document.getElementById('restrictionType').value;
            const emailDiv = document.getElementById('emailRestrictions');
            const courseDiv = document.getElementById('courseRestrictions');
            
            emailDiv.style.display = (restrictionType === 'email' || restrictionType === 'both') ? 'block' : 'none';
            courseDiv.style.display = (restrictionType === 'course' || restrictionType === 'both') ? 'block' : 'none';
        }
    </script>
    
    <%- include('partials/footer') %>
</body>
</html>