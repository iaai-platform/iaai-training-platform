<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Library - In-Person Courses</title>
  <link rel="stylesheet" href="/css/inpersonlibrarystyle.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <%- include('partials/header') %>

  <!-- Hero Section -->
  <section id="hero">
    <div class="hero-content">
      <h1><i class="fas fa-users"></i> In-Person Training Library</h1>
      <p>Access your in-person training courses, materials, and certificates.</p>
    </div>
  </section>

  <!-- Statistics Section -->
  <section class="library-stats">
    <div class="stats-grid <%= linkedCourses > 0 ? 'has-linked' : '' %>">
      <div class="stat-item">
        <div class="stat-number"><%= totalCourses %></div>
        <div class="stat-label">Total Courses</div>
      </div>
      <div class="stat-item">
        <div class="stat-number"><%= attendedCourses %></div>
        <div class="stat-label">Attended</div>
      </div>
      <div class="stat-item">
        <div class="stat-number"><%= upcomingCourses %></div>
        <div class="stat-label">Upcoming</div>
      </div>
      <div class="stat-item">
        <div class="stat-number"><%= completedCourses %></div>
        <div class="stat-label">Certificates</div>
      </div>
      <% if (linkedCourses > 0) { %>
        <div class="stat-item">
          <div class="stat-number"><%= linkedCourses %></div>
          <div class="stat-label">Linked Programs</div>
        </div>
      <% } %>
    </div>
  </section>

  <!-- Library Navigation Tabs -->
  <section style="max-width: 1400px; margin: 0 auto 40px; padding: 0 20px;">
    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
      <a href="/library/self-paced" class="cta-btn btn-secondary">
        <i class="fas fa-play-circle"></i> Self-Paced Courses
      </a>
      <a href="/library/live" class="cta-btn btn-secondary">
        <i class="fas fa-video"></i> Live Online Courses
      </a>
      <a href="/library/in-person" class="cta-btn btn-primary">
        <i class="fas fa-users"></i> In-Person Courses
      </a>
    </div>
  </section>

  <!-- Filter and Search Section -->
  <section style="max-width: 1400px; margin: 0 auto 30px; padding: 0 20px;">
    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Search Courses</label>
          <input type="text" id="courseSearch" placeholder="Search by title, location, instructor..." 
                 style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Status Filter</label>
          <select id="statusFilter" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
            <option value="">All Statuses</option>
            <option value="upcoming">Upcoming</option>
            <option value="completed">Completed</option>
            <option value="attended">Attended</option>
            <option value="needs-action">Needs Action</option>
          </select>
        </div>
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Sort By</label>
          <select id="sortBy" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="title">Title A-Z</option>
            <option value="status">Status</option>
          </select>
        </div>
        <div>
          <button onclick="clearFilters()" style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600;">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Library Content Section -->
  <section id="library-content">
    <div class="section-header">
      <h2>Your In-Person Training Courses</h2>
      <p>Manage your attendance and access course materials</p>
    </div>

    <% if (myCourses && myCourses.length > 0) { %>
      <div class="course-list" id="courseList">
        <% myCourses.forEach((course, index) => { %>
          <div class="course-card <%= course.canViewCertificate ? 'completed' : (course.attendanceConfirmed ? 'in-progress' : (new Date(course.startDate) > new Date() ? 'upcoming' : 'needs-action')) %>" 
               style="--card-index: <%= index %>"
               data-title="<%= course.title %>" 
               data-location="<%= course.location %>" 
               data-instructor="<%= course.instructor %>"
               data-status="<%= course.canViewCertificate ? 'completed' : (course.attendanceConfirmed ? 'attended' : (new Date(course.startDate) > new Date() ? 'upcoming' : 'needs-action')) %>"
               data-date="<%= course.startDate %>">
            
            <!-- Enhanced Course Header -->
            <div class="course-header">
              <div class="course-status <%= course.canViewCertificate ? 'status-completed' : (course.attendanceConfirmed ? 'status-progress' : (new Date(course.startDate) > new Date() ? 'status-upcoming' : 'status-needs-action')) %>">
                <% if (course.canViewCertificate) { %>
                  <i class="fas fa-medal"></i> Certified
                <% } else if (course.attendanceConfirmed && !course.canViewCertificate) { %>
                  <% if (course.assessmentRequired && !course.assessmentCompleted) { %>
                    <i class="fas fa-clipboard-question"></i> Assessment Pending
                  <% } else if (course.assessmentRequired && !course.assessmentPassed) { %>
                    <i class="fas fa-times-circle"></i> Assessment Failed
                  <% } else { %>
                    <i class="fas fa-hourglass-half"></i> Processing
                  <% } %>
                <% } else if (new Date(course.startDate) > new Date()) { %>
                  <i class="fas fa-calendar-alt"></i> Upcoming
                <% } else if (course.courseEnded) { %>
                  <i class="fas fa-exclamation-circle"></i> Action Required
                <% } else { %>
                  <i class="fas fa-clock"></i> In Progress
                <% } %>
              </div>
              
              <!-- NEW: Linked Course Badge for IN-PERSON courses -->
              <% if (course.linkedCourse && course.linkedCourse.isLinked) { %>
                <div class="linked-course-badge">
                  <i class="fas fa-link"></i>
                  <span class="linked-course-text">Linked to Online</span>
                </div>
              <% } %>
              
              <h3 class="course-title"><%= course.title %></h3>
              <p class="course-code">Course Code: <%= course.courseCode %></p>
              <div class="course-meta">
                <i class="fas fa-calendar"></i> <%= new Date(course.startDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                <% if (course.endDate && course.endDate !== course.startDate) { %>
                  - <%= new Date(course.endDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                <% } %>
                <br>
                <i class="fas fa-map-marker-alt"></i> <%= course.location %> - <%= course.venue %>
                <br>
                <i class="fas fa-user-tie"></i> Instructor: <%= course.instructor || 'IAAI Team' %>
                <% if (course.duration) { %>
                  <br>
                  <i class="fas fa-clock"></i> Duration: <%= course.duration %>
                <% } %>
              </div>
            </div>

            <!-- Course Body -->
            <div class="course-body">
              <!-- Course Description -->
              <p class="course-description"><%= course.description %></p>

              <!-- Course Information Grid -->
              <div class="course-info-grid">
                <div class="course-info-item">
                  <div class="info-label">
                    <i class="fas fa-chalkboard-teacher"></i> Instructor
                  </div>
                  <div class="info-value"><%= course.instructor || 'IAAI Team' %></div>
                </div>
                
                <div class="course-info-item">
                  <div class="info-label">
                    <i class="fas fa-calendar"></i> Start Date
                  </div>
                  <div class="info-value">
                    <%= new Date(course.startDate).toLocaleDateString() %>
                  </div>
                </div>
                
                <div class="course-info-item">
                  <div class="info-label">
                    <i class="fas fa-map-marker-alt"></i> Location
                  </div>
                  <div class="info-value"><%= course.location %></div>
                </div>
                
                <div class="course-info-item">
                  <div class="info-label">
                    <i class="fas fa-building"></i> Venue
                  </div>
                  <div class="info-value"><%= course.venue %></div>
                </div>
                
                <% if (course.courseEnded) { %>
                  <div class="course-info-item">
                    <div class="info-label">
                      <i class="fas fa-calendar-check"></i> End Date
                    </div>
                    <div class="info-value">
                      <%= new Date(course.endDate || course.startDate).toLocaleDateString() %>
                    </div>
                  </div>
                <% } %>
                
                <div class="course-info-item">
                  <div class="info-label">
                    <i class="fas fa-users"></i> Attendance
                  </div>
                  <div class="info-value">
                    <% if (course.attendanceConfirmed) { %>
                      <span style="color: #28a745; font-weight: 600;">
                        <i class="fas fa-check-circle"></i> Confirmed
                      </span>
                    <% } else { %>
                      <span style="color: #dc3545;">
                        <i class="fas fa-times-circle"></i> Not Confirmed
                      </span>
                    <% } %>
                  </div>
                </div>
              </div>

              <!-- NEW: Linked Course Information for IN-PERSON -->
              <% if (course.linkedCourse && course.linkedCourse.isLinked) { %>
                <div class="linked-course-info" style="margin: 20px 0;">
                  <div style="background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%); padding: 20px; border-radius: 12px; border: 2px solid #17a2b8;">
                    <h5 style="color: #17a2b8; margin: 0 0 15px 0; font-size: 1.2rem;">
                      <i class="fas fa-link"></i> Multi-Component Training Program
                    </h5>
                    
                    <div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                      <div style="color: #17a2b8; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> <strong>This in-person course is part of a comprehensive training program:</strong>
                      </div>
                      <div style="margin-top: 10px; color: #0c5460;">
                        <i class="fas fa-users" style="color: #17a2b8; width: 20px;"></i> <strong>In-Person Component:</strong> <%= course.title %><br>
                        <i class="fas fa-laptop" style="color: #17a2b8; width: 20px;"></i> <strong>Online Component:</strong> <%= course.linkedCourse.linkedCourseTitle || 'Virtual Training' %>
                        <% if (course.linkedCourse.linkedCoursePlatform) { %>
                          <br><i class="fas fa-video" style="color: #17a2b8; width: 20px;"></i> <strong>Platform:</strong> <%= course.linkedCourse.linkedCoursePlatform %>
                        <% } %>
                        <% if (course.linkedCourse.linkedCourseCode) { %>
                          <br><i class="fas fa-code" style="color: #17a2b8; width: 20px;"></i> <strong>Online Course Code:</strong> <%= course.linkedCourse.linkedCourseCode %>
                        <% } %>
                      </div>
                    </div>

                    <% if (course.linkedCourse.linkType) { %>
                      <div style="background: rgba(23, 162, 184, 0.1); padding: 12px; border-radius: 8px;">
                        <div style="color: #0c5460; font-size: 0.9rem;">
                          <% if (course.linkedCourse.linkType === "prerequisite") { %>
                            <i class="fas fa-arrow-right"></i> <strong>Online Prerequisite:</strong> The online component should be completed before this in-person training.
                          <% } else if (course.linkedCourse.linkType === "follow-up") { %>
                            <i class="fas fa-graduation-cap"></i> <strong>Follow-up Training:</strong> This in-person course builds upon the online foundation.
                          <% } else { %>
                            <i class="fas fa-link"></i> <strong>Linked Training:</strong> Part of a comprehensive learning program.
                          <% } %>
                        </div>
                      </div>
                    <% } %>
                  </div>
                </div>
              <% } %>

              <!-- Assessment Information (Enhanced) -->
              <% if (course.assessmentRequired) { %>
                <div class="course-info-section" style="margin: 20px 0;">
                  <h5 style="color: #333; margin-bottom: 10px;">
                    <i class="fas fa-clipboard-check"></i> Assessment Status
                  </h5>
                  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    
                    <% if (course.assessmentCompleted && course.assessmentPassed) { %>
                      <!-- âœ… ASSESSMENT PASSED -->
                      <div style="color: #28a745; font-weight: 600;">
                        <i class="fas fa-trophy"></i> Assessment Completed Successfully
                        <span style="float: right; font-weight: normal;">
                          Score: <%= course.assessmentScore %>% (Required: <%= course.passingScore || 70 %>%)
                        </span>
                      </div>
                      <div style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                        <i class="fas fa-calendar-check"></i> Completed: <%= course.lastAssessmentDate ? new Date(course.lastAssessmentDate).toLocaleDateString() : 'Recently' %><br>
                        <i class="fas fa-redo"></i> Attempts Used: <%= course.currentAttempts %> of <%= course.maxAttempts %>
                      </div>
                      
                    <% } else if (course.hasAttempted && !course.assessmentPassed) { %>
                      <!-- âŒ ASSESSMENT FAILED -->
                      <div style="color: #dc3545; font-weight: 600;">
                        <i class="fas fa-times-circle"></i> Assessment Not Passed
                        <span style="float: right; font-weight: normal;">
                          Score: <%= course.assessmentScore %>% (Required: <%= course.passingScore || 70 %>%)
                        </span>
                      </div>
                      <div style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                        <i class="fas fa-calendar-times"></i> Last Attempt: <%= course.lastAssessmentDate ? new Date(course.lastAssessmentDate).toLocaleDateString() : 'Recently' %><br>
                        <i class="fas fa-redo"></i> Attempts: <%= course.currentAttempts %> of <%= course.maxAttempts %>
                        <% if (course.canRetake) { %>
                          <br><span style="color: #ffc107;"><i class="fas fa-info-circle"></i> You can retake the assessment</span>
                        <% } %>
                      </div>
                      
                    <% } else { %>
                      <!-- â³ ASSESSMENT PENDING -->
                      <div style="color: #ffc107; font-weight: 600;">
                        <i class="fas fa-clock"></i> Assessment Pending
                        <span style="float: right; font-weight: normal;">
                          Required: <%= course.passingScore || 70 %>%
                        </span>
                      </div>
                      <div style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                        Assessment Type: <%= course.assessmentType ? course.assessmentType.charAt(0).toUpperCase() + course.assessmentType.slice(1) : 'Quiz' %>
                        <br>Attempts available: <%= course.maxAttempts %>
                      </div>
                    <% } %>
                  </div>
                </div>
              <% } %>

              <!-- Course Registration Information -->
              <div class="course-info-section" style="margin: 20px 0;">
                <h5 style="color: #333; margin-bottom: 10px;">
                  <i class="fas fa-info-circle"></i> Registration Information
                </h5>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                  <div style="display: grid; gap: 10px;">
                    <div><i class="fas fa-calendar-check" style="color: #17a2b8; width: 20px;"></i> <strong>Registered:</strong> <%= new Date(course.dateOfRegistration).toLocaleDateString() %></div>
                    <% if (course.status) { %>
                      <div><i class="fas fa-flag" style="color: #17a2b8; width: 20px;"></i> <strong>Status:</strong> <%= course.status.charAt(0).toUpperCase() + course.status.slice(1) %></div>
                    <% } %>
                    <% if (course.duration) { %>
                      <div><i class="fas fa-clock" style="color: #17a2b8; width: 20px;"></i> <strong>Duration:</strong> <%= course.duration %></div>
                    <% } %>
                  </div>
                </div>
              </div>

              <!-- Course Materials Section -->
              <% 
                const hasDocuments = course.media?.documents?.length > 0;
                const hasImages = course.media?.images?.length > 0;
                const hasVideos = course.media?.videos?.length > 0;
                const hasLinks = course.media?.links?.length > 0;
                const hasPromotional = course.media?.promotional?.brochureUrl || 
                                     course.media?.promotional?.videoUrl || 
                                     course.media?.promotional?.catalogUrl;
                const hasAnyMaterials = hasDocuments || hasImages || hasVideos || hasPromotional || hasLinks;
              %>

              <% if (hasAnyMaterials) { %>
                <div class="video-section">
                  <h4><i class="fas fa-folder-open"></i> Course Materials</h4>
                  <div class="video-list">
                    
<!-- FIXED Documents Section -->
<!-- FIXED Documents Section with View Option -->
<% if (hasDocuments) { %>
  <% course.media.documents.forEach((docUrl, index) => { %>
    <% 
      let fileName = 'Document ' + (index + 1);
      let fileExt = 'pdf';
      
      try {
        if (docUrl.includes('fl_attachment:')) {
          const attachMatch = docUrl.match(/fl_attachment:([^\/]+)/);
          if (attachMatch) {
            fileName = decodeURIComponent(attachMatch[1]);
            fileExt = fileName.split('.').pop().toLowerCase();
          }
        } else if (docUrl.includes('cloudinary.com')) {
          const urlParts = docUrl.split('/');
          const fileWithExt = urlParts[urlParts.length - 1];
          if (fileWithExt && fileWithExt.includes('.')) {
            fileName = fileWithExt;
            fileExt = fileName.split('.').pop().toLowerCase();
          } else {
            const versionIndex = urlParts.findIndex(part => part.startsWith('v'));
            if (versionIndex !== -1 && urlParts[versionIndex + 1]) {
              const pathAfterVersion = urlParts.slice(versionIndex + 1).join('/');
              const cleanFileName = pathAfterVersion.split('/').pop();
              if (cleanFileName) {
                fileName = cleanFileName;
                fileExt = fileName.split('.').pop().toLowerCase() || 'pdf';
              }
            }
          }
        }
      } catch (e) {
        console.log('Error extracting filename:', e);
      }
      
      let icon = 'fa-file-pdf';
      let fileType = 'PDF Document';
      let bgColor = '#dc3545';
      
      if (['doc', 'docx'].includes(fileExt)) {
        icon = 'fa-file-word';
        fileType = 'Word Document';
        bgColor = '#0066cc';
      } else if (['ppt', 'pptx'].includes(fileExt)) {
        icon = 'fa-file-powerpoint';
        fileType = 'Presentation';
        bgColor = '#dc3545';
      } else if (['xls', 'xlsx'].includes(fileExt)) {
        icon = 'fa-file-excel';
        fileType = 'Spreadsheet';
        bgColor = '#28a745';
      }
    %>
    <div class="video-item">
      <div class="video-number" style="background: <%= bgColor %>;">
        <i class="fas <%= icon %>"></i>
      </div>
      <div class="video-info">
        <div class="video-title"><%= fileName %></div>
        <div class="video-meta">
          <i class="fas <%= icon %>"></i> <%= fileType %>
        </div>
      </div>
      <div class="video-actions">
        <!-- NEW: Secure View Button -->
        <a href="/library/view-document/<%= course.courseId %>/<%= index %>" 
           target="_blank" 
           class="video-action action-watch" 
           style="background: linear-gradient(135deg, #667eea, #764ba2);">
          <i class="fas fa-lock"></i> Secure View
        </a>
        <!-- Original view button (optional - can be removed) -->
        <a href="<%= docUrl %>#toolbar=0" 
           target="_blank" 
           class="video-action action-exam" 
           rel="noopener noreferrer">
          <i class="fas fa-eye"></i> Quick View
        </a>
      </div>
    </div>
  <% }) %>
<% } %>
                    
                    <!-- Videos -->
                    <% if (hasVideos) { %>
                      <% course.media.videos.forEach((videoUrl, index) => { %>
                        <% 
                          const videoName = videoUrl.split('/').pop() || `Video ${index + 1}`;
                          const isYouTube = videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be');
                          const isVimeo = videoUrl.includes('vimeo.com');
                        %>
                        <div class="video-item">
                          <div class="video-number" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <i class="fas fa-play-circle"></i>
                          </div>
                          <div class="video-info">
                            <div class="video-title"><%= videoName %></div>
                            <div class="video-meta">
                              <i class="fas fa-video"></i> Video Material
                              <% if (isYouTube) { %>
                                â€¢ <i class="fab fa-youtube"></i> YouTube
                              <% } else if (isVimeo) { %>
                                â€¢ <i class="fab fa-vimeo"></i> Vimeo
                              <% } %>
                            </div>
                          </div>
                          <div class="video-actions">
                            <a href="<%= videoUrl %>" target="_blank" class="video-action action-watch">
                              <i class="fas fa-play"></i> Watch
                            </a>
                          </div>
                        </div>
                      <% }) %>
                    <% } %>

                    <!-- External Links -->
                    <% if (hasLinks) { %>
                      <% course.media.links.forEach((link, index) => { %>
                        <% 
                          let linkIcon = 'fa-link';
                          let linkColor = '#17a2b8';
                          
                          if (link.type === 'video') {
                            linkIcon = 'fa-play-circle';
                            linkColor = '#dc3545';
                          } else if (link.type === 'article') {
                            linkIcon = 'fa-newspaper';
                            linkColor = '#28a745';
                          } else if (link.type === 'tool') {
                            linkIcon = 'fa-tools';
                            linkColor = '#ffc107';
                          }
                        %>
                        <div class="video-item">
                          <div class="video-number" style="background: <%= linkColor %>;">
                            <i class="fas <%= linkIcon %>"></i>
                          </div>
                          <div class="video-info">
                            <div class="video-title"><%= link.title || `External Link ${index + 1}` %></div>
                            <div class="video-meta">
                              <i class="fas <%= linkIcon %>"></i> <%= link.type ? link.type.charAt(0).toUpperCase() + link.type.slice(1) : 'External Link' %>
                            </div>
                          </div>
                          <div class="video-actions">
                            <a href="<%= link.url %>" target="_blank" class="video-action action-watch">
                              <i class="fas fa-external-link-alt"></i> Open
                            </a>
                          </div>
                        </div>
                      <% }) %>
                    <% } %>
                    
                    <!-- Promotional Materials -->
                    <% if (hasPromotional) { %>
                      <% if (course.media.promotional.brochureUrl) { %>
                        <div class="video-item">
                          <div class="video-number" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <i class="fas fa-book-open"></i>
                          </div>
                          <div class="video-info">
                            <div class="video-title">Course Brochure</div>
                            <div class="video-meta">
                              <i class="fas fa-book-open"></i> Official Brochure
                            </div>
                          </div>
                          <div class="video-actions">
                            <a href="<%= course.media.promotional.brochureUrl %>" target="_blank" class="video-action action-exam">
                              <i class="fas fa-download"></i> Download
                            </a>
                            <a href="<%= course.media.promotional.brochureUrl %>" target="_blank" class="video-action action-review">
                              <i class="fas fa-eye"></i> View
                            </a>
                          </div>
                        </div>
                      <% } %>
                      
                      <% if (course.media.promotional.catalogUrl) { %>
                        <div class="video-item">
                          <div class="video-number" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                            <i class="fas fa-book"></i>
                          </div>
                          <div class="video-info">
                            <div class="video-title">Course Catalog</div>
                            <div class="video-meta">
                              <i class="fas fa-book"></i> Full Catalog
                            </div>
                          </div>
                          <div class="video-actions">
                            <a href="<%= course.media.promotional.catalogUrl %>" target="_blank" class="video-action action-exam">
                              <i class="fas fa-download"></i> Download
                            </a>
                            <a href="<%= course.media.promotional.catalogUrl %>" target="_blank" class="video-action action-review">
                              <i class="fas fa-eye"></i> View
                            </a>
                          </div>
                        </div>
                      <% } %>
                      
                      <% if (course.media.promotional.videoUrl) { %>
                        <div class="video-item">
                          <div class="video-number" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <i class="fas fa-film"></i>
                          </div>
                          <div class="video-info">
                            <div class="video-title">Promotional Video</div>
                            <div class="video-meta">
                              <i class="fas fa-film"></i> Course Overview
                            </div>
                          </div>
                          <div class="video-actions">
                            <a href="<%= course.media.promotional.videoUrl %>" target="_blank" class="video-action action-watch">
                              <i class="fas fa-play"></i> Watch
                            </a>
                          </div>
                        </div>
                      <% } %>
                    <% } %>
                    
                    <!-- Gallery Images -->
                    <% if (hasImages) { %>
                      <div class="video-item">
                        <div class="video-number" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                          <i class="fas fa-images"></i>
                        </div>
                        <div class="video-info">
                          <div class="video-title">Course Gallery</div>
                          <div class="video-meta">
                            <i class="fas fa-images"></i> <%= course.media.images.length %> Image<%= course.media.images.length > 1 ? 's' : '' %>
                          </div>
                        </div>
                        <div class="video-actions">
                          <button class="video-action action-review" onclick="showImageGallery('<%= course.courseId %>')">
                            <i class="fas fa-eye"></i> View Gallery
                          </button>
                        </div>
                      </div>
                    <% } %>
                  </div>
                </div>
              <% } %>

              <!-- Course Status and Next Steps -->
              <% if (course.courseEnded && !course.canViewCertificate) { %>
                <div class="course-info-section" style="margin: 20px 0;">
                  
                  <!-- Step 1: Attendance Confirmation (FIRST) -->
                  <% if (!course.attendanceConfirmed) { %>
                    <% if (course.canConfirmAttendance) { %>
                      <!-- âœ… ATTENDANCE AVAILABLE -->
                      <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px; border-radius: 12px; border: 2px solid #ffc107; margin-bottom: 15px;">
                        <h5 style="color: #856404; margin: 0 0 10px 0;">
                          <i class="fas fa-user-check"></i> Step 1: Confirm Your Attendance
                        </h5>
                        <p style="margin: 0 0 15px 0; color: #856404;">
                          <% if (course.courseInProgress) { %>
                            <i class="fas fa-clock"></i> Course is currently in progress. You can confirm your attendance now.
                          <% } else if (course.courseEnded) { %>
                            <i class="fas fa-calendar-times"></i> Course has ended. Please confirm your attendance within the grace period.
                            <br><small>Grace period ends: <%= new Date(course.attendanceGracePeriodEnd).toLocaleDateString() %></small>
                          <% } %>
                        </p>
                        <button class="cta-btn btn-confirm-attendance" 
                                data-course-id="<%= course.courseId %>"
                                data-course-type="<%= course.courseType %>"
                                style="margin: 0;">
                          <i class="fas fa-check"></i> Confirm Attendance
                        </button>
                      </div>
                    <% } else { %>
                      <!-- âœ… GRACE PERIOD EXPIRED -->
                      <div style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); padding: 20px; border-radius: 12px; border: 2px solid #dc3545; margin-bottom: 15px;">
                        <h5 style="color: #721c24; margin: 0 0 10px 0;">
                          <i class="fas fa-exclamation-triangle"></i> Step 1: Attendance Confirmation Expired
                        </h5>
                        <p style="margin: 0 0 15px 0; color: #721c24;">
                          The grace period for confirming attendance has expired. Please contact support if you attended this course.
                        </p>
                        <a href="/contact" class="cta-btn btn-secondary" style="margin: 0;">
                          <i class="fas fa-envelope"></i> Contact Support
                        </a>
                      </div>
                    <% } %>
                  <% } else { %>
                    <!-- âœ… ATTENDANCE CONFIRMED -->
                    <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 15px; border-radius: 12px; border: 2px solid #28a745; margin-bottom: 15px;">
                      <h5 style="color: #155724; margin: 0 0 5px 0;">
                        <i class="fas fa-check-circle"></i> Step 1: Attendance Confirmed âœ…
                      </h5>
                      <p style="margin: 0; color: #155724; font-size: 0.9rem;">
                        <% if (course.attendanceDate) { %>
                          Confirmed on <%= new Date(course.attendanceDate).toLocaleDateString() %>
                        <% } else { %>
                          Attendance confirmed
                        <% } %>
                      </p>
                    </div>
                  <% } %>

                  <!-- Step 2: Assessment (SECOND) -->
                  <% if (course.assessmentRequired) { %>
                    <div style="background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%); padding: 20px; border-radius: 12px; border: 2px solid #17a2b8;">
                      <h5 style="color: #17a2b8; margin: 0 0 15px 0;">
                        <i class="fas fa-clipboard-check"></i> Step 2: Complete Assessment
                        <% if (course.assessmentCompleted && course.assessmentPassed) { %>
                          <span style="color: #28a745; font-size: 0.9rem; margin-left: 10px;">âœ… COMPLETED</span>
                        <% } %>
                      </h5>
                      <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                        <div><i class="fas fa-target" style="color: #17a2b8; width: 20px;"></i> <strong>Passing Score:</strong> <%= course.passingScore %>%</div>
                        <div><i class="fas fa-question-circle" style="color: #17a2b8; width: 20px;"></i> <strong>Assessment Type:</strong> <%= course.assessmentType ? course.assessmentType.charAt(0).toUpperCase() + course.assessmentType.slice(1) : 'Quiz' %></div>
                        <div><i class="fas fa-redo" style="color: #17a2b8; width: 20px;"></i> <strong>Attempts:</strong> <%= course.currentAttempts %> of <%= course.maxAttempts %></div>
                      </div>
                      
                      <% if (course.assessmentCompleted && course.assessmentPassed) { %>
                        <!-- COMPLETED STATE -->
                        <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 15px; border-radius: 12px; border: 2px solid #28a745; margin-bottom: 15px;">
                          <h6 style="color: #155724; margin: 0 0 10px 0;">
                            <i class="fas fa-trophy"></i> Assessment Completed Successfully!
                          </h6>
                          <div style="color: #155724;">
                            <i class="fas fa-check-circle"></i> <strong>Score:</strong> <%= course.assessmentScore %>% - <span style="color: #28a745; font-weight: 700;">PASSED</span><br>
                            <% if (course.lastAssessmentDate) { %>
                              <i class="fas fa-calendar-check"></i> <strong>Completed:</strong> <%= new Date(course.lastAssessmentDate).toLocaleDateString() %><br>
                            <% } %>
                            <i class="fas fa-redo"></i> <strong>Attempts Used:</strong> <%= course.currentAttempts %> of <%= course.maxAttempts %>
                          </div>
                        </div>
                        
                      <% } else if (course.assessmentCompleted && !course.assessmentPassed) { %>
                        <!-- FAILED STATE -->
                        <div style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); padding: 15px; border-radius: 12px; border: 2px solid #dc3545; margin-bottom: 15px;">
                          <h6 style="color: #721c24; margin: 0 0 10px 0;">
                            <i class="fas fa-times-circle"></i> Assessment Not Passed
                          </h6>
                          <div style="color: #721c24;">
                            <i class="fas fa-chart-line"></i> <strong>Your Score:</strong> <%= course.assessmentScore %>%<br>
                            <i class="fas fa-target"></i> <strong>Required:</strong> <%= course.passingScore %>%<br>
                            <i class="fas fa-redo"></i> <strong>Attempts:</strong> <%= course.currentAttempts %> of <%= course.maxAttempts %>
                            <% if (course.canRetake) { %>
                              <br><span style="color: #ffc107;"><i class="fas fa-info-circle"></i> You can retake the assessment</span>
                            <% } %>
                          </div>
                        </div>
                        
                        <% if (course.canRetake) { %>
                          <a href="/library/in-person/assessment/<%= course.courseId %>" 
                             class="cta-btn btn-warning" style="margin: 0;">
                            <i class="fas fa-redo"></i> Retake Assessment
                          </a>
                        <% } %>
                        
                      <% } else { %>
                        <!-- NOT STARTED STATE -->
                        <p style="margin: 0 0 15px 0; color: #17a2b8;">
                          <% if (!course.attendanceConfirmed) { %>
                            <i class="fas fa-lock"></i> Complete Step 1 (Attendance) first to unlock assessment.
                          <% } else { %>
                            <i class="fas fa-play-circle"></i> Ready to take assessment.
                          <% } %>
                        </p>
                        
                        <% if (course.attendanceConfirmed) { %>
                          <a href="/library/in-person/assessment/<%= course.courseId %>" 
                             class="cta-btn btn-primary" style="margin: 0;">
                            <i class="fas fa-clipboard-check"></i> Take Assessment
                          </a>
                        <% } else { %>
                          <button class="cta-btn" 
                                  style="background: #6c757d; color: white; cursor: not-allowed; margin: 0;" 
                                  disabled>
                            <i class="fas fa-lock"></i> Assessment Locked
                          </button>
                        <% } %>
                      <% } %>
                    </div>
                  <% } else { %>
                    <!-- No Assessment Required -->
                    <% if (course.attendanceConfirmed && course.canGetCertificate) { %>
                      <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 15px; border-radius: 12px; border: 2px solid #28a745; margin-bottom: 15px;">
                        <h6 style="color: #155724; margin: 0 0 10px 0;">
                          <i class="fas fa-check-circle"></i> Course Completed Successfully!
                        </h6>
                        <p style="margin: 0; color: #155724;">
                          No assessment required for this course. You can now generate your certificate.
                        </p>
                      </div>
                    <% } %>
                  <% } %>
                </div>
              <% } else if (!course.courseEnded) { %>
                <!-- Course Not Ended Yet -->
                <div class="course-info-section" style="margin: 20px 0;">
                  <% if (course.courseNotStarted) { %>
                    <!-- âœ… COURSE NOT STARTED -->
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4f4dd 100%); padding: 20px; border-radius: 12px; border: 2px solid #4caf50;">
                      <h5 style="color: #2e7d32; margin: 0 0 15px 0;">
                        <i class="fas fa-calendar-alt"></i> Course Schedule
                      </h5>
                      <div style="display: grid; gap: 10px;">
                        <div><i class="fas fa-hourglass-start" style="color: #2e7d32; width: 20px;"></i> <strong>Status:</strong> Course starts in <%= Math.ceil((new Date(course.startDate) - new Date()) / (1000 * 60 * 60 * 24)) %> days</div>
                        <div><i class="fas fa-calendar-alt" style="color: #2e7d32; width: 20px;"></i> <strong>Start Date:</strong> <%= new Date(course.startDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></div>
                        <% if (course.endDate && course.endDate !== course.startDate) { %>
                          <div><i class="fas fa-calendar-times" style="color: #2e7d32; width: 20px;"></i> <strong>End Date:</strong> <%= new Date(course.endDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></div>
                        <% } %>
                      </div>
                      <div style="margin-top: 15px; color: #2e7d32; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> Attendance confirmation will be available during and after the course.
                      </div>
                    </div>
                  <% } else if (course.courseInProgress) { %>
                    <!-- âœ… COURSE IN PROGRESS -->
                    <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px; border-radius: 12px; border: 2px solid #ffc107;">
                      <h5 style="color: #856404; margin: 0 0 15px 0;">
                        <i class="fas fa-play-circle"></i> Course in Progress
                      </h5>
                      <div style="display: grid; gap: 10px;">
                        <div><i class="fas fa-calendar-alt" style="color: #856404; width: 20px;"></i> <strong>Started:</strong> <%= new Date(course.startDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></div>
                        <% if (course.endDate && course.endDate !== course.startDate) { %>
                          <div><i class="fas fa-calendar-times" style="color: #856404; width: 20px;"></i> <strong>Ends:</strong> <%= new Date(course.endDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></div>
                        <% } %>
                      </div>
                      <div style="margin-top: 15px; color: #856404; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> You can confirm your attendance now or after the course ends.
                      </div>
                    </div>
                  <% } %>
                </div>
              <% } %>

              <!-- Enhanced Action Buttons with Status-Aware Logic -->
              <div class="course-actions">
  
                <!-- ========================================= -->
                <!-- âœ… STEP 1: ATTENDANCE BUTTON (FIRST PRIORITY) -->
                <!-- ========================================= -->
                
                <% 
                  const now = new Date();
                  const courseStarted = new Date(course.startDate) <= now;
                  const courseEnded = new Date(course.endDate || course.startDate) < now;
                  const courseInProgress = courseStarted && !courseEnded;
                  const gracePeriodEnd = new Date(course.endDate || course.startDate);
                  gracePeriodEnd.setDate(gracePeriodEnd.getDate() + 7);
                  const withinGracePeriod = now <= gracePeriodEnd;
                %>
                
                <% if (!course.attendanceConfirmed) { %>
                  <% if (courseStarted && withinGracePeriod) { %>
                    <!-- âœ… ATTENDANCE AVAILABLE (Course started) -->
                    <button class="cta-btn btn-confirm-attendance" 
                            data-course-id="<%= course.courseId %>" 
                            data-course-type="<%= course.courseType %>"
                            style="background: #28a745; animation: pulse 2s infinite;">
                      <i class="fas fa-check"></i> 
                      <% if (courseInProgress) { %>
                        Confirm Attendance (Course Active)
                      <% } else if (courseEnded) { %>
                        Confirm Attendance (Grace Period)
                      <% } else { %>
                        Confirm Attendance
                      <% } %>
                    </button>
                  <% } else if (!courseStarted) { %>
                    <!-- ðŸ”’ ATTENDANCE LOCKED (Course not started) -->
                    <div class="cta-btn" style="background: #6c757d; color: white; cursor: not-allowed; position: relative;">
                      <i class="fas fa-lock"></i> 
                      Attendance (Available <%= new Date(course.startDate).toLocaleDateString() %>)
                      <div class="tooltip-text" style="position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; margin-bottom: 5px; opacity: 0; transition: opacity 0.3s; pointer-events: none;">
                        Available when course starts
                      </div>
                    </div>
                  <% } else { %>
                    <!-- ðŸ”’ ATTENDANCE EXPIRED -->
                    <div class="cta-btn" style="background: #dc3545; color: white; cursor: not-allowed;">
                      <i class="fas fa-exclamation-triangle"></i> 
                      Attendance Period Expired
                    </div>
                    <a href="/contact" class="cta-btn btn-secondary">
                      <i class="fas fa-envelope"></i> Contact Support
                    </a>
                  <% } %>
                <% } else { %>
                  <!-- âœ… ATTENDANCE COMPLETED -->
                  <div class="cta-btn" style="background: #28a745; color: white; cursor: default;">
                    <i class="fas fa-check-circle"></i> 
                    Attendance Confirmed âœ…
                  </div>
                <% } %>
              
                <!-- ========================================= -->
                <!-- âœ… STEP 2: ASSESSMENT BUTTON (SECOND PRIORITY) -->
                <!-- ========================================= -->
                
                <% if (course.assessmentRequired) { %>
                  <% if (course.attendanceConfirmed && courseStarted) { %>
                    <% if (!course.assessmentCompleted) { %>
                      <!-- âœ… ASSESSMENT AVAILABLE (Attendance confirmed + Course started) -->
                      <a href="/library/in-person/assessment/<%= course.courseId %>" 
                         class="cta-btn btn-primary" 
                         style="animation: pulse 2s infinite;">
                        <i class="fas fa-clipboard-check"></i> Take Assessment
                      </a>
                      
                    <% } else if (!course.assessmentPassed && course.canRetake) { %>
                      <!-- âœ… RETAKE ASSESSMENT -->
                      <a href="/library/in-person/assessment/<%= course.courseId %>" 
                         class="cta-btn btn-warning"
                         style="animation: pulse 2s infinite;">
                        <i class="fas fa-redo"></i> Retake Assessment 
                        <small>(Attempt <%= (course.currentAttempts || 0) + 1 %> of <%= course.maxAttempts || 3 %>)</small>
                      </a>
                      
                    <% } else if (!course.assessmentPassed && !course.canRetake) { %>
                      <!-- âŒ NO MORE ATTEMPTS -->
                      <div class="cta-btn" style="background: #dc3545; color: white; cursor: not-allowed;">
                        <i class="fas fa-times-circle"></i> 
                        Assessment Failed (No retakes left)
                      </div>
                      <a href="/contact" class="cta-btn btn-secondary">
                        <i class="fas fa-envelope"></i> Contact Support
                      </a>
                      
                    <% } else { %>
                      <!-- âœ… ASSESSMENT COMPLETED -->
                      <div class="cta-btn" style="background: #28a745; color: white; cursor: default;">
                        <i class="fas fa-trophy"></i> 
                        Assessment Passed âœ… (<%= course.assessmentScore %>%)
                      </div>
                    <% } %>
                    
                  <% } else if (!course.attendanceConfirmed) { %>
                    <!-- ðŸ”’ ASSESSMENT LOCKED (Attendance not confirmed) -->
                    <div class="cta-btn" style="background: #6c757d; color: white; cursor: not-allowed; position: relative;">
                      <i class="fas fa-lock"></i> 
                      Assessment (Confirm Attendance First)
                      <div class="tooltip-text" style="position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; margin-bottom: 5px; opacity: 0; transition: opacity 0.3s; pointer-events: none;">
                        Complete Step 1 first
                      </div>
                    </div>
                    
                  <% } else if (!courseStarted) { %>
                    <!-- ðŸ”’ ASSESSMENT LOCKED (Course not started) -->
                    <div class="cta-btn" style="background: #6c757d; color: white; cursor: not-allowed; position: relative;">
                      <i class="fas fa-lock"></i> 
                      Assessment (Available <%= new Date(course.startDate).toLocaleDateString() %>)
                      <div class="tooltip-text" style="position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; margin-bottom: 5px; opacity: 0; transition: opacity 0.3s; pointer-events: none;">
                        Available when course starts
                      </div>
                    </div>
                  <% } %>
                <% } %>
              
                <!-- ========================================= -->
                <!-- âœ… ASSESSMENT RESULTS BUTTON (Always show when completed) -->
                <!-- ========================================= -->
                <% if (course.assessmentRequired && course.assessmentCompleted) { %>
                  <% if (course.assessmentPassed) { %>
                    <!-- âœ… PASSED: Show results with success styling -->
                    <a href="/library/in-person/assessment/<%= course.courseId %>/results" class="cta-btn btn-success">
                      <i class="fas fa-chart-line"></i> View Results 
                      <small>(Passed: <%= course.assessmentScore %>%)</small>
                    </a>
                  <% } else { %>
                    <!-- âŒ FAILED: Show results with warning styling -->
                    <a href="/library/in-person/assessment/<%= course.courseId %>/results" class="cta-btn btn-warning">
                      <i class="fas fa-chart-line"></i> View Results 
                      <small>(Score: <%= course.assessmentScore %>%)</small>
                    </a>
                  <% } %>
                <% } %>
              
                <!-- ========================================= -->
                <!-- âœ… STEP 3: CERTIFICATE BUTTON (FINAL STEP) -->
                <!-- ========================================= -->
                
                <% if (course.canViewCertificate && course.hasCertificate) { %>
                  <!-- âœ… CERTIFICATE AVAILABLE -->
                  <a href="/certificates/view/<%= course.certificateId %>" 
                     class="cta-btn btn-certificate"
                     style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; font-weight: bold;">
                    <i class="fas fa-certificate"></i> View Certificate
                  </a>
                  <button onclick="downloadCertificate('<%= course.certificateId %>')" 
                          class="cta-btn btn-secondary">
                    <i class="fas fa-download"></i> Download PDF
                  </button>
                  
                <% } else if (course.canGetCertificate && !course.hasCertificate) { %>
                  <!-- âœ… CERTIFICATE READY TO GENERATE -->
                  <button class="cta-btn btn-generate-certificate" 
                          data-course-id="<%= course.courseId %>" 
                          data-course-type="<%= course.courseType %>"
                          data-course-title="<%= course.title %>"
                          style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold; animation: pulse 2s infinite;">
                    <i class="fas fa-trophy"></i> Generate Certificate
                  </button>
                  
                <% } else { %>
                  <!-- ðŸ”’ CERTIFICATE LOCKED -->
                  <% 
                    let lockReason = '';
                    let lockIcon = 'fa-lock';
                    let lockColor = '#6c757d';
                    
                    if (!courseEnded) {
                      lockReason = `Certificate (Available after ${new Date(course.endDate || course.startDate).toLocaleDateString()})`;
                      lockIcon = 'fa-calendar';
                    } else if (!course.attendanceConfirmed) {
                      lockReason = 'Certificate (Confirm Attendance First)';
                      lockIcon = 'fa-user-check';
                      lockColor = '#ffc107';
                    } else if (course.assessmentRequired && !course.assessmentPassed) {
                      lockReason = 'Certificate (Pass Assessment First)';
                      lockIcon = 'fa-clipboard-check';
                      lockColor = '#dc3545';
                    } else {
                      lockReason = 'Certificate (Processing...)';
                      lockIcon = 'fa-hourglass-half';
                      lockColor = '#17a2b8';
                    }
                  %>
                  
                  <div class="cta-btn" 
                       style="background: <%= lockColor %>; color: white; cursor: not-allowed; position: relative;"
                       onmouseover="this.querySelector('.tooltip-text').style.opacity='1'"
                       onmouseout="this.querySelector('.tooltip-text').style.opacity='0'">
                    <i class="fas <%= lockIcon %>"></i> 
                    <%= lockReason %>
                    <div class="tooltip-text" style="position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 8px 12px; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; margin-bottom: 5px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000;">
                      <% if (!courseEnded) { %>
                        Complete the course first
                      <% } else if (!course.attendanceConfirmed) { %>
                        Step 1: Confirm your attendance
                      <% } else if (course.assessmentRequired && !course.assessmentPassed) { %>
                        Step 2: Pass the assessment
                      <% } else { %>
                        Requirements completed - processing...
                      <% } %>
                    </div>
                  </div>
                <% } %>
              
                <!-- ========================================= -->
                <!-- âœ… GENERAL COURSE ACTIONS (Always Available) -->
                <!-- ========================================= -->
                
                <!-- Course Details Link -->
                <a href="/in-person/courses/<%= course.courseId %>" class="cta-btn btn-outline-secondary">
                  <i class="fas fa-info-circle"></i> Course Details
                </a>
              
                <!-- Print Details -->
                <button onclick="printCourseCard(this.closest('.course-card'))" class="cta-btn btn-outline-secondary">
                  <i class="fas fa-print"></i> Print Details
                </button>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
      
      <!-- No Results State -->
      <div id="noResults" class="empty-state" style="display: none;">
        <i class="fas fa-search"></i>
        <h3>No courses match your search</h3>
        <p>Try adjusting your filters or search terms.</p>
        <button onclick="clearFilters()" class="cta-btn btn-primary">
          <i class="fas fa-times"></i> Clear Filters
        </button>
      </div>
      
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-users"></i>
        <h3>No in-person courses in your library yet</h3>
        <p>Register for an in-person training course to see it here.</p>
        <div class="course-actions">
          <a href="/in-person-aesthetic-training" class="cta-btn btn-primary">
            <i class="fas fa-search"></i> Browse In-Person Courses
          </a>
        </div>
      </div>
    <% } %>
  </section>

  <!-- Image Gallery Modal -->
  <div id="galleryModal" class="gallery-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);">
    <div class="gallery-content" style="position: relative; margin: auto; padding: 20px; width: 90%; max-width: 1200px; top: 5%;">
      <div class="gallery-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: white; margin: 0;">Course Gallery</h2>
        <span class="gallery-close" onclick="closeGallery()" style="color: white; font-size: 2rem; cursor: pointer; font-weight: bold;">&times;</span>
      </div>
      <div id="galleryGrid" class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;"></div>
    </div>
  </div>

  <!-- Lightbox for full-size images -->
  <div id="lightbox" class="lightbox" onclick="closeLightbox()" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95);">
    <span class="lightbox-close" style="position: absolute; top: 15px; right: 35px; color: white; font-size: 40px; font-weight: bold; cursor: pointer;">&times;</span>
    <div class="lightbox-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
      <img id="lightboxImg" src="" alt="Full size image" style="max-width: 100%; max-height: 100%; object-fit: contain;">
    </div>
  </div>

  <!-- Complete JavaScript Functionality -->
  <script>
    // Store gallery images for each course
    const courseGalleries = {};
    <% if (myCourses) { %>
      <% myCourses.forEach(course => { %>
        <% if (course.media?.images?.length > 0) { %>
          courseGalleries['<%= course.courseId %>'] = <%= JSON.stringify(course.media.images) %>;
        <% } %>
      <% }) %>
    <% } %>
    
    // Enhanced Certificate and Attendance Management
    document.addEventListener('DOMContentLoaded', function() {
      initializeFilters();
      initializeCertificateSystem();
      initializeAttendanceSystem();
      initializeProgressiveEnhancements();
    });

    // ========================================
    // FILTER AND SEARCH FUNCTIONALITY
    // ========================================
    
    function initializeFilters() {
      const courseSearch = document.getElementById('courseSearch');
      const statusFilter = document.getElementById('statusFilter');
      const sortBy = document.getElementById('sortBy');
      
      if (courseSearch) courseSearch.addEventListener('input', filterCourses);
      if (statusFilter) statusFilter.addEventListener('change', filterCourses);
      if (sortBy) sortBy.addEventListener('change', sortCourses);
    }
    
    function filterCourses() {
      const searchTerm = document.getElementById('courseSearch')?.value.toLowerCase() || '';
      const statusFilter = document.getElementById('statusFilter')?.value || '';
      const courseCards = document.querySelectorAll('.course-card');
      let visibleCount = 0;
      
      courseCards.forEach(card => {
        const title = card.dataset.title?.toLowerCase() || '';
        const location = card.dataset.location?.toLowerCase() || '';
        const instructor = card.dataset.instructor?.toLowerCase() || '';
        const status = card.dataset.status || '';
        
        const matchesSearch = !searchTerm || 
          title.includes(searchTerm) || 
          location.includes(searchTerm) || 
          instructor.includes(searchTerm);
        
        const matchesStatus = !statusFilter || status === statusFilter;
        
        if (matchesSearch && matchesStatus) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      // Show/hide no results message
      const noResults = document.getElementById('noResults');
      if (noResults) {
        if (visibleCount === 0 && courseCards.length > 0) {
          noResults.style.display = 'block';
        } else {
          noResults.style.display = 'none';
        }
      }
    }
    
    function sortCourses() {
      const sortBy = document.getElementById('sortBy')?.value || 'date-desc';
      const courseList = document.getElementById('courseList');
      const courseCards = Array.from(document.querySelectorAll('.course-card'));
      
      if (!courseList) return;
      
      courseCards.sort((a, b) => {
        switch(sortBy) {
          case 'title':
            return (a.dataset.title || '').localeCompare(b.dataset.title || '');
          case 'date-asc':
            return new Date(a.dataset.date || 0) - new Date(b.dataset.date || 0);
          case 'date-desc':
            return new Date(b.dataset.date || 0) - new Date(a.dataset.date || 0);
          case 'status':
            return (a.dataset.status || '').localeCompare(b.dataset.status || '');
          default:
            return new Date(b.dataset.date || 0) - new Date(a.dataset.date || 0);
        }
      });
      
      // Reorder DOM elements
      courseCards.forEach(card => courseList.appendChild(card));
    }
    
    function clearFilters() {
      const courseSearch = document.getElementById('courseSearch');
      const statusFilter = document.getElementById('statusFilter');
      const sortBy = document.getElementById('sortBy');
      
      if (courseSearch) courseSearch.value = '';
      if (statusFilter) statusFilter.value = '';
      if (sortBy) sortBy.value = 'date-desc';
      
      filterCourses();
      sortCourses();
    }

    // ========================================
    // CERTIFICATE SYSTEM WITH LINKED COURSE AWARENESS
    // ========================================
    
    function initializeCertificateSystem() {
      document.querySelectorAll('.btn-generate-certificate').forEach(button => {
        button.addEventListener('click', async function() {
          const courseId = this.dataset.courseId;
          const courseType = this.dataset.courseType;
          const courseTitle = this.dataset.courseTitle;
          
          // Check if this is a linked course
          const courseCard = this.closest('.course-card');
          const linkedCourseInfo = courseCard.querySelector('.linked-course-info');
          const isLinkedCourse = !!linkedCourseInfo;
          
          // Enhanced confirmation dialog for linked courses
          const confirmationHtml = `
            <div style="text-align: center;">
              <i class="fas fa-certificate" style="font-size: 3rem; color: #ffd700; margin-bottom: 15px;"></i>
              <p>Are you ready to generate your certificate for:</p>
              <h4 style="color: #333; margin: 10px 0;">"${courseTitle}"</h4>
              ${isLinkedCourse ? `
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                  <div style="color: #17a2b8; font-weight: 600;">
                    <i class="fas fa-link"></i> <strong>Multi-Component Training Certificate</strong><br>
                    <span style="font-size: 0.9rem; opacity: 0.8;">
                      This certificate recognizes completion of your comprehensive training program.
                    </span>
                  </div>
                </div>
              ` : `
                <p style="color: #666; font-size: 0.9rem;">This will create your official completion certificate.</p>
              `}
              <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <div style="color: #155724; font-weight: 600;">
                  <i class="fas fa-check-circle" style="color: #28a745;"></i> All requirements completed<br>
                  <i class="fas fa-award" style="color: #28a745;"></i> Ready for certification
                </div>
              </div>
            </div>
          `;
          
          const result = await Swal.fire({
            title: isLinkedCourse ? 'Generate Comprehensive Certificate' : 'Generate Certificate',
            html: confirmationHtml,
            icon: null,
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="fas fa-trophy"></i> Yes, Generate Certificate',
            cancelButtonText: 'Cancel'
          });
          
          if (!result.isConfirmed) return;
          
          // Show loading state
          const originalText = this.innerHTML;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Certificate...';
          this.disabled = true;
          this.classList.add('loading');
          
          try {
            const response = await fetch('/certificates/api/issue', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                courseId: courseId,
                courseType: courseType
              })
            });
            
            const data = await response.json();
            
            if (data.success) {
              // Enhanced success message for linked courses
              const successHtml = `
                <div style="text-align: center;">
                  <i class="fas fa-medal" style="font-size: 4rem; color: #ffd700; margin-bottom: 20px;"></i>
                  <h3 style="color: #28a745;">Congratulations!</h3>
                  <p>Your ${isLinkedCourse ? 'comprehensive training' : ''} certificate has been successfully generated.</p>
                  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>Certificate ID:</strong> ${data.certificate.certificateId}<br>
                    <strong>Verification Code:</strong> ${data.certificate.verificationCode}
                  </div>
                  <p style="color: #666; font-size: 0.9rem;">You can now view, download, and share your certificate.</p>
                </div>
              `;
              
              await Swal.fire({
                title: 'Certificate Generated! ðŸŽ‰',
                html: successHtml,
                icon: null,
                confirmButtonColor: '#007bff',
                confirmButtonText: '<i class="fas fa-eye"></i> View Certificate'
              });
              
              // Redirect to certificate view
              window.location.href = `/certificates/view/${data.certificate.certificateId}`;
              
            } else {
              throw new Error(data.message || 'Failed to generate certificate');
            }
            
          } catch (error) {
            console.error('Error generating certificate:', error);
            
            Swal.fire({
              icon: 'error',
              title: 'Certificate Generation Failed',
              text: error.message || 'Failed to generate certificate. Please try again or contact support.',
              confirmButtonColor: '#dc3545'
            });
            
            // Restore button
            this.innerHTML = originalText;
            this.disabled = false;
            this.classList.remove('loading');
          }
        });
      });
    }

    // ========================================
    // ATTENDANCE SYSTEM WITH LINKED COURSE CONTEXT
    // ========================================
    
    function initializeAttendanceSystem() {
      document.querySelectorAll('.btn-confirm-attendance').forEach(button => {
        button.addEventListener('click', async function() {
          const courseId = this.dataset.courseId;
          const courseType = this.dataset.courseType;
          const courseTitle = this.closest('.course-card').querySelector('.course-title').textContent;
          
          // Check if this is a linked course
          const courseCard = this.closest('.course-card');
          const linkedCourseInfo = courseCard.querySelector('.linked-course-info');
          const isLinkedCourse = !!linkedCourseInfo;
          
          // Enhanced confirmation dialog for linked courses
          const confirmationHtml = `
            <div style="text-align: center;">
              <i class="fas fa-user-check" style="font-size: 3rem; color: #28a745; margin-bottom: 15px;"></i>
              <p>Please confirm that you attended:</p>
              <h4 style="color: #333; margin: 10px 0;">"${courseTitle}"</h4>
              ${isLinkedCourse ? `
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                  <div style="color: #17a2b8; font-weight: 600;">
                    <i class="fas fa-link"></i> <strong>Part of Multi-Component Training</strong><br>
                    <span style="font-size: 0.9rem; opacity: 0.8;">
                      This course is part of your comprehensive training program.
                    </span>
                  </div>
                </div>
              ` : ''}
              <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; color: #856404;">
                <i class="fas fa-info-circle"></i> 
                <strong>Important:</strong> Only confirm if you actually attended this course.
              </div>
            </div>
          `;
          
          const result = await Swal.fire({
            title: 'Confirm Attendance',
            html: confirmationHtml,
            icon: null,
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="fas fa-check"></i> Yes, I Attended',
            cancelButtonText: 'Cancel'
          });
          
          if (!result.isConfirmed) return;
          
          // Show loading state
          const originalText = this.innerHTML;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirming...';
          this.disabled = true;
          this.classList.add('loading');
          
          try {
            const response = await fetch(`/library/confirm-attendance/${courseId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                courseType: courseType
              })
            });
            
            const data = await response.json();
            
            if (data.success) {
              // Enhanced success message with linked course context
              let successMessage = data.message;
              
              if (data.linkedCourseInfo && data.linkedCourseInfo.isLinked) {
                successMessage += `\n\n${data.linkedCourseInfo.message}`;
              }
              
              await Swal.fire({
                icon: 'success',
                title: 'Attendance Confirmed! âœ…',
                text: successMessage,
                confirmButtonColor: '#28a745'
              });
              
              // Reload page to show updated state
              window.location.reload();
              
            } else {
              throw new Error(data.message);
            }
            
          } catch (error) {
            console.error('Error confirming attendance:', error);
            
            Swal.fire({
              icon: 'error',
              title: 'Confirmation Failed',
              text: error.message || 'Failed to confirm attendance. Please try again.',
              confirmButtonColor: '#dc3545'
            });
            
            // Restore button
            this.innerHTML = originalText;
            this.disabled = false;
            this.classList.remove('loading');
          }
        });
      });
    }

    // ========================================
    // CERTIFICATE ACTIONS (Download & Share)
    // ========================================
    
    window.downloadCertificate = async function(certificateId) {
      try {
        const response = await fetch(`/certificates/download/${certificateId}`);
        const data = await response.json();
        
        if (data.success) {
          if (data.downloadUrl) {
            const link = document.createElement('a');
            link.href = data.downloadUrl;
            link.download = `certificate-${certificateId}.pdf`;
            link.click();
            
            // Show success toast
            Swal.fire({
              icon: 'success',
              title: 'Download Started! ðŸ“¥',
              text: 'Your certificate is downloading...',
              timer: 2000,
              timerProgressBar: true,
              showConfirmButton: false,
              toast: true,
              position: 'top-end'
            });
          } else {
            Swal.fire({
              icon: 'info',
              title: 'PDF Generation Coming Soon',
              text: 'PDF download functionality will be available soon. You can currently share your certificate verification link.',
              confirmButtonColor: '#17a2b8'
            });
          }
        }
      } catch (error) {
        console.error('Download error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Download Failed',
          text: 'Failed to download certificate. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      }
    };

    // ========================================
    // GALLERY FUNCTIONALITY
    // ========================================
    
    function showImageGallery(courseId) {
      const modal = document.getElementById('galleryModal');
      const grid = document.getElementById('galleryGrid');
      const images = courseGalleries[courseId] || [];
      
      if (!modal || !grid) return;
      
      // Clear previous content
      grid.innerHTML = '';
      
      if (images.length === 0) {
        grid.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">No images available for this course.</p>';
        modal.style.display = 'block';
        return;
      }
      
      // Add images to grid
      images.forEach((imageUrl, index) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.style.cssText = 'cursor: pointer; position: relative; overflow: hidden; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);';
        item.innerHTML = `
          <img src="${imageUrl}" 
               alt="Course image ${index + 1}" 
               onclick="openLightbox('${imageUrl}')" 
               style="width: 100%; height: 200px; object-fit: cover; transition: transform 0.3s ease;" 
               onmouseover="this.style.transform='scale(1.05)'" 
               onmouseout="this.style.transform='scale(1)'"
               onerror="this.parentElement.style.display='none'">
          <div style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">
            ${index + 1}/${images.length}
          </div>
        `;
        grid.appendChild(item);
      });
      
      modal.style.display = 'block';
    }
    
    function closeGallery() {
      const modal = document.getElementById('galleryModal');
      if (modal) modal.style.display = 'none';
    }
    
    function openLightbox(imageUrl) {
      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      if (lightbox && img) {
        img.src = imageUrl;
        lightbox.style.display = 'block';
        
        // Add keyboard navigation for lightbox
        const handleKeyPress = (e) => {
          if (e.key === 'Escape') {
            closeLightbox();
            document.removeEventListener('keydown', handleKeyPress);
          }
        };
        document.addEventListener('keydown', handleKeyPress);
      }
    }
    
    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      if (lightbox) lightbox.style.display = 'none';
    }

    // ========================================
    // PROGRESSIVE ENHANCEMENT
    // ========================================
    
    function initializeProgressiveEnhancements() {
      // Check for modern browser features
      const hasModernFeatures = 'fetch' in window && 'Promise' in window;
      
      if (!hasModernFeatures) {
        // Fallback for older browsers
        document.querySelectorAll('.btn-generate-certificate, .btn-confirm-attendance').forEach(button => {
          button.onclick = function() {
            alert('This feature requires a modern browser. Please update your browser and try again.');
          };
        });
        return;
      }

      // Initialize all modern features
      initializeCardInteractions();
      initializePrintSupport();
      initializeAccessibility();
      initializePerformanceOptimizations();
    }

    // Add hover effects to course cards
    function initializeCardInteractions() {
      document.querySelectorAll('.course-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-4px) scale(1.01)';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0) scale(1)';
        });
      });
    }

    // Initialize print functionality
    function initializePrintSupport() {
      // Add print button functionality
      document.querySelectorAll('.course-card').forEach(card => {
        // Print functionality is handled by inline onclick
      });
    }

    function printCourseCard(card) {
      const courseTitle = card.querySelector('.course-title').textContent;
      const courseContent = card.cloneNode(true);
      
      // Remove interactive elements
      courseContent.querySelectorAll('.course-actions, .video-actions, button').forEach(el => el.remove());
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Course Details - ${courseTitle}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .course-card { box-shadow: none; border: 1px solid #ddd; }
            .course-header { background: #f8f9fa !important; color: #333 !important; }
            @media print {
              body { margin: 0; }
              .course-card { border: none; box-shadow: none; }
            }
          </style>
        </head>
        <body>
          <h1>Course Details</h1>
          ${courseContent.outerHTML}
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 0.9rem;">
            Generated on: ${new Date().toLocaleDateString()} | IAAI Training Institute
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    // Accessibility enhancements
    function initializeAccessibility() {
      // Add ARIA labels to interactive elements
      document.querySelectorAll('.cta-btn').forEach(button => {
        if (!button.getAttribute('aria-label')) {
          const text = button.textContent.trim();
          button.setAttribute('aria-label', text);
        }
      });
      
      // Add keyboard navigation to course cards
      document.querySelectorAll('.course-card').forEach((card, index) => {
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'article');
        card.setAttribute('aria-label', `Course: ${card.querySelector('.course-title').textContent}`);
        
        card.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const detailsLink = this.querySelector('a[href*="/courses/"]');
            if (detailsLink) detailsLink.click();
          }
        });
      });
    }

    // Performance optimizations
    function initializePerformanceOptimizations() {
      // Lazy load images in gallery
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              if (img.dataset.src) {
                img.src = img.dataset.src;
                img.classList.remove('lazy');
                observer.unobserve(img);
              }
            }
          });
        });
        
        document.querySelectorAll('img[data-src]').forEach(img => {
          imageObserver.observe(img);
        });
      }
      
      // Debounce search input
      let searchTimeout;
      const searchInput = document.getElementById('courseSearch');
      if (searchInput) {
        searchInput.removeEventListener('input', filterCourses);
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(filterCourses, 300);
        });
      }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const galleryModal = document.getElementById('galleryModal');
      const lightbox = document.getElementById('lightbox');
      
      if (event.target == galleryModal) {
        closeGallery();
      }
      if (event.target == lightbox) {
        closeLightbox();
      }
    }

    // Enhanced keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeGallery();
        closeLightbox();
      }
      
      // Add Ctrl+F for search focus
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.getElementById('courseSearch');
        if (searchInput) {
          searchInput.focus();
          searchInput.select();
        }
      }
    });
  </script>

  <%- include('partials/footer') %>
</body>
</html>