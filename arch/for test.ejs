<!-- Course Status and Next Steps -->
<% if (course.courseEnded && !course.canViewCertificate) { %>
    <div class="course-info-section" style="margin: 20px 0;">
      
      <!-- Step 1: Attendance Confirmation (FIRST) -->
      <% if (!course.attendanceConfirmed) { %>
        <% if (course.canConfirmAttendance) { %>
          <!-- ✅ ATTENDANCE AVAILABLE -->
          <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px; border-radius: 12px; border: 2px solid #ffc107; margin-bottom: 15px;">
            <h5 style="color: #856404; margin: 0 0 10px 0;">
              <i class="fas fa-user-check"></i> Step 1: Confirm Your Attendance
            </h5>
            <p style="margin: 0 0 15px 0; color: #856404;">
              <% if (course.courseInProgress) { %>
                <i class="fas fa-clock"></i> Course is currently in progress. You can confirm your attendance now.
              <% } else if (course.courseEnded) { %>
                <i class="fas fa-calendar-times"></i> Course has ended. Please confirm your attendance within the grace period.
                <br><small>Grace period ends: <%= new Date(course.attendanceGracePeriodEnd).toLocaleDateString() %></small>
              <% } %>
            </p>
            <button class="cta-btn btn-confirm-attendance" 
                    data-course-id="<%= course.courseId %>"
                    data-course-type="<%= course.courseType %>"
                    style="margin: 0;">
              <i class="fas fa-check"></i> Confirm Attendance
            </button>
          </div>
        <% } else { %>
          <!-- ✅ GRACE PERIOD EXPIRED -->
          <div style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); padding: 20px; border-radius: 12px; border: 2px solid #dc3545; margin-bottom: 15px;">
            <h5 style="color: #721c24; margin: 0 0 10px 0;">
              <i class="fas fa-exclamation-triangle"></i> Step 1: Attendance Confirmation Expired
            </h5>
            <p style="margin: 0 0 15px 0; color: #721c24;">
              The grace period for confirming attendance has expired. Please contact support if you attended this course.
            </p>
            <a href="/contact" class="cta-btn btn-secondary" style="margin: 0;">
              <i class="fas fa-envelope"></i> Contact Support
            </a>
          </div>
        <% } %>
      <% } else { %>
        <!-- ✅ ATTENDANCE CONFIRMED -->
        <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 15px; border-radius: 12px; border: 2px solid #28a745; margin-bottom: 15px;">
          <h5 style="color: #155724; margin: 0 0 5px 0;">
            <i class="fas fa-check-circle"></i> Step 1: Attendance Confirmed ✅
          </h5>
          <p style="margin: 0; color: #155724; font-size: 0.9rem;">
            <% if (course.attendanceDate) { %>
              Confirmed on <%= new Date(course.attendanceDate).toLocaleDateString() %>
            <% } else { %>
              Attendance confirmed
            <% } %>
          </p>
        </div>
      <% } %>
  
      <!-- Step 2: Assessment (SECOND) -->
      <% if (course.assessmentRequired) { %>
        <div style="background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%); padding: 20px; border-radius: 12px; border: 2px solid #17a2b8;">
          <h5 style="color: #17a2b8; margin: 0 0 15px 0;">
            <i class="fas fa-clipboard-check"></i> Step 2: Complete Assessment
            <% if (course.assessmentCompleted && course.assessmentPassed) { %>
              <span style="color: #28a745; font-size: 0.9rem; margin-left: 10px;">✅ COMPLETED</span>
            <% } %>
          </h5>
          <div style="display: grid; gap: 10px; margin-bottom: 15px;">
            <div><i class="fas fa-target" style="color: #17a2b8; width: 20px;"></i> <strong>Passing Score:</strong> <%= course.passingScore %>%</div>
            <div><i class="fas fa-question-circle" style="color: #17a2b8; width: 20px;"></i> <strong>Assessment Type:</strong> <%= course.assessmentType ? course.assessmentType.charAt(0).toUpperCase() + course.assessmentType.slice(1) : 'Quiz' %></div>
            <div><i class="fas fa-redo" style="color: #17a2b8; width: 20px;"></i> <strong>Attempts:</strong> <%= course.currentAttempts %> of <%= course.maxAttempts %></div>
          </div>
          
          <% if (course.assessmentCompleted && course.assessmentPassed) { %>
            <!-- COMPLETED STATE -->
            <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 15px; border-radius: 12px; border: 2px solid #28a745; margin-bottom: 15px;">
              <h6 style="color: #155724; margin: 0 0 10px 0;">
                <i class="fas fa-trophy"></i> Assessment Completed Successfully!
              </h6>
              <div style="color: #155724;">
                <i class="fas fa-check-circle"></i> <strong>Score:</strong> <%= course.assessmentScore %>% - <span style="color: #28a745; font-weight: 700;">PASSED</span><br>
                <% if (course.lastAssessmentDate) { %>
                  <i class="fas fa-calendar-check"></i> <strong>Completed:</strong> <%= new Date(course.lastAssessmentDate).toLocaleDateString() %><br>
                <% } %>
                <i class="fas fa-redo"></i> <strong>Attempts Used:</strong> <%= course.currentAttempts %> of <%= course.maxAttempts %>
              </div>
            </div>
            
          <% } else if (course.assessmentCompleted && !course.assessmentPassed) { %>
            <!-- FAILED STATE -->
            <div style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); padding: 15px; border-radius: 12px; border: 2px solid #dc3545; margin-bottom: 15px;">
              <h6 style="color: #721c24; margin: 0 0 10px 0;">
                <i class="fas fa-times-circle"></i> Assessment Not Passed
              </h6>
              <div style="color: #721c24;">
                <i class="fas fa-chart-line"></i> <strong>Your Score:</strong> <%= course.assessmentScore %>%<br>
                <i class="fas fa-target"></i> <strong>Required:</strong> <%= course.passingScore %>%<br>
                <i class="fas fa-redo"></i> <strong>Attempts:</strong> <%= course.currentAttempts %> of <%= course.maxAttempts %>
                <% if (course.canRetake) { %>
                  <br><span style="color: #ffc107;"><i class="fas fa-info-circle"></i> You can retake the assessment</span>
                <% } %>
              </div>
            </div>
            
            <% if (course.canRetake) { %>
              <a href="/library/in-person/assessment/<%= course.courseId %>" 
                 class="cta-btn btn-warning" style="margin: 0;">
                <i class="fas fa-redo"></i> Retake Assessment
              </a>
            <% } %>
            
          <% } else { %>
            <!-- NOT STARTED STATE -->
            <p style="margin: 0 0 15px 0; color: #17a2b8;">
              <% if (!course.attendanceConfirmed) { %>
                <i class="fas fa-lock"></i> Complete Step 1 (Attendance) first to unlock assessment.
              <% } else { %>
                <i class="fas fa-play-circle"></i> Ready to take assessment.
              <% } %>
            </p>
            
            <% if (course.attendanceConfirmed) { %>
              <a href="/library/in-person/assessment/<%= course.courseId %>" 
                 class="cta-btn btn-primary" style="margin: 0;">
                <i class="fas fa-clipboard-check"></i> Take Assessment
              </a>
            <% } else { %>
              <button class="cta-btn" 
                      style="background: #6c757d; color: white; cursor: not-allowed; margin: 0;" 
                      disabled>
                <i class="fas fa-lock"></i> Assessment Locked
              </button>
            <% } %>
          <% } %>
        </div>
      <% } else { %>
        <!-- No Assessment Required -->
        <% if (course.attendanceConfirmed && course.canGetCertificate) { %>
          <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 15px; border-radius: 12px; border: 2px solid #28a745; margin-bottom: 15px;">
            <h6 style="color: #155724; margin: 0 0 10px 0;">
              <i class="fas fa-check-circle"></i> Course Completed Successfully!
            </h6>
            <p style="margin: 0; color: #155724;">
              No assessment required for this course. You can now generate your certificate.
            </p>
          </div>
        <% } %>
      <% } %>
    </div>
  <% } else if (!course.courseEnded) { %>
    <!-- Course Not Ended Yet -->
    <div class="course-info-section" style="margin: 20px 0;">
      <% if (course.courseNotStarted) { %>
        <!-- ✅ COURSE NOT STARTED -->
        <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4f4dd 100%); padding: 20px; border-radius: 12px; border: 2px solid #4caf50;">
          <h5 style="color: #2e7d32; margin: 0 0 15px 0;">
            <i class="fas fa-calendar-alt"></i> Course Schedule
          </h5>
          <div style="display: grid; gap: 10px;">
            <div><i class="fas fa-hourglass-start" style="color: #2e7d32; width: 20px;"></i> <strong>Status:</strong> Course starts in <%= Math.ceil((new Date(course.startDate) - new Date()) / (1000 * 60 * 60 * 24)) %> days</div>
            <div><i class="fas fa-calendar-alt" style="color: #2e7d32; width: 20px;"></i> <strong>Start Date:</strong> <%= new Date(course.startDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></div>
            <% if (course.endDate && course.endDate !== course.startDate) { %>
              <div><i class="fas fa-calendar-times" style="color: #2e7d32; width: 20px;"></i> <strong>End Date:</strong> <%= new Date(course.endDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></div>
            <% } %>
          </div>
          <div style="margin-top: 15px; color: #2e7d32; font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> Attendance confirmation will be available during and after the course.
          </div>
        </div>
      <% } else if (course.courseInProgress) { %>
        <!-- ✅ COURSE IN PROGRESS -->
        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px; border-radius: 12px; border: 2px solid #ffc107;">
          <h5 style="color: #856404; margin: 0 0 15px 0;">
            <i class="fas fa-play-circle"></i> Course in Progress
          </h5>
          <div style="display: grid; gap: 10px;">
            <div><i class="fas fa-calendar-alt" style="color: #856404; width: 20px;"></i> <strong>Started:</strong> <%= new Date(course.startDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></div>
            <% if (course.endDate && course.endDate !== course.startDate) { %>
              <div><i class="fas fa-calendar-times" style="color: #856404; width: 20px;"></i> <strong>Ends:</strong> <%= new Date(course.endDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></div>
            <% } %>
          </div>
          <div style="margin-top: 15px; color: #856404; font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> You can confirm your attendance now or after the course ends.
          </div>
        </div>
      <% } %>
    </div>
  <% } %>
  
  <!-- Enhanced Action Buttons with Status-Aware Logic -->
  <div class="course-actions">
    <% if (course.canViewCertificate && course.hasCertificate) { %>
      <!-- Certificate is available -->
      <a href="/certificates/view/<%= course.certificateId %>" class="cta-btn btn-certificate">
        <i class="fas fa-certificate"></i> View Certificate
      </a>
      <button onclick="downloadCertificate('<%= course.certificateId %>')" class="cta-btn btn-secondary">
        <i class="fas fa-download"></i> Download PDF
      </button>
    <% } else if (course.canGetCertificate && !course.hasCertificate) { %>
      <!-- All requirements met - can generate certificate -->
      <button class="cta-btn btn-generate-certificate" 
              data-course-id="<%= course.courseId %>" 
              data-course-type="<%= course.courseType %>"
              data-course-title="<%= course.title %>">
        <i class="fas fa-trophy"></i> Generate Certificate
      </button>
    <% } else if (course.canConfirmAttendance) { %>
      <!-- Show attendance confirmation button -->
      <button class="cta-btn btn-confirm-attendance" 
              data-course-id="<%= course.courseId %>" 
              data-course-type="<%= course.courseType %>">
        <i class="fas fa-check"></i> Confirm Attendance
      </button>
    <% } else if (course.assessmentRequired && course.attendanceConfirmed && !course.assessmentCompleted && course.courseEnded) { %>
      <!-- Assessment available -->
      <a href="/library/in-person/assessment/<%= course.courseId %>" class="cta-btn btn-warning">
        <i class="fas fa-clipboard-check"></i> Take Assessment
      </a>
    <% } else if (course.assessmentRequired && !course.assessmentPassed && course.canRetake) { %>
      <!-- Assessment failed but can retake -->
      <a href="/library/in-person/assessment/<%= course.courseId %>" class="cta-btn btn-warning">
        <i class="fas fa-redo"></i> Retake Assessment
      </a>
    <% } else { %>
      <!-- Course not started, in progress, or awaiting next steps -->
      <div class="cta-btn" style="background: #f8f9fa; color: #666; cursor: not-allowed;">
        <i class="fas fa-calendar"></i> 
        <% if (course.courseNotStarted) { %>
          Starts <%= new Date(course.startDate).toLocaleDateString() %>
        <% } else if (course.courseInProgress) { %>
          Course in Progress
        <% } else if (!course.attendanceConfirmed && !course.canConfirmAttendance) { %>
          Attendance Period Expired
        <% } else { %>
          Processing...
        <% } %>
      </div>
    <% } %>
    
    <!-- Course details link -->
    <a href="/in-person/courses/<%= course.courseId %>" class="cta-btn btn-secondary">
      <i class="fas fa-info-circle"></i> Course Details
    </a>
  </div>